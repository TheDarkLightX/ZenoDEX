# [FORGE] ZenoDEX CPMM Swap v7 (A+ Grade)
ir_version: "esso-ir/v1"
meta:
  model_id: "cpmm_swap_v7"
  created_by: "production-spec"
  notes: |
    A+ production-grade CPMM swap with:
    - Explicit k-preservation guard (k_after >= k_before)
    - Explicit cannot-drain-pool guard (amount_out < reserve_out)
    - Symmetric post-update bounds for both reserves

    Formula: amount_out = floor(reserve_out * amount_in / (reserve_in + amount_in))

    IR semantics note:
    - Action `updates` are evaluated on the pre-state and applied simultaneously.
    - Action `effects` are evaluated on the post-state (new_state).
    - `reserve_in_before`/`reserve_out_before` exist only to snapshot pre-state for effects/witnessing.

observables:
  state_vars: ["reserve_in", "reserve_out"]
  effects: ["amount_out", "new_reserve_in", "new_reserve_out", "k_before", "k_after"]

types: []

state_vars:
  - id: "reserve_in_before"
    role: "data"
    type: { kind: "int", min: 1, max: 3000000000 }
  - id: "reserve_in"
    role: "data"
    type: { kind: "int", min: 1, max: 3000000000 }
  - id: "reserve_out_before"
    role: "data"
    type: { kind: "int", min: 1, max: 3000000000 }
  - id: "reserve_out"
    role: "data"
    type: { kind: "int", min: 1, max: 3000000000 }

init:
  - var: "reserve_in_before"
    expr: { const: 1000000 }
  - var: "reserve_in"
    expr: { const: 1000000 }
  - var: "reserve_out_before"
    expr: { const: 1000000 }
  - var: "reserve_out"
    expr: { const: 1000000 }

invariants:
  - id: "inv_reserve_in_bounded"
    kind: "safety"
    expr:
      op: "and"
      args:
        - { op: ">", args: [{ var: "reserve_in" }, { const: 0 }] }
        - { op: "<=", args: [{ var: "reserve_in" }, { const: 3000000000 }] }
  - id: "inv_reserve_out_bounded"
    kind: "safety"
    expr:
      op: "and"
      args:
        - { op: ">", args: [{ var: "reserve_out" }, { const: 0 }] }
        - { op: "<=", args: [{ var: "reserve_out" }, { const: 3000000000 }] }

actions:
  - id: "swap"
    params:
      - id: "amount_in"
        type: { kind: "int", min: 1, max: 3000000000 }
      - id: "min_amount_out"
        type: { kind: "int", min: 1, max: 3000000000 }
    guard:
      op: "and"
      args:
        # Reserves must be positive
        - { op: ">", args: [{ var: "reserve_in" }, { const: 0 }] }
        - { op: ">", args: [{ var: "reserve_out" }, { const: 0 }] }
        # Amount in must be positive
        - { op: ">", args: [{ param: "amount_in" }, { const: 0 }] }
        # Reasonable trade size
        - { op: "<=", args: [{ param: "amount_in" }, { var: "reserve_in" }] }
        # POST-UPDATE BOUND: reserve_in + amount_in <= 3B
        - { op: "<=",
            args: [
              { op: "+", args: [{ var: "reserve_in" }, { param: "amount_in" }] },
              { const: 3000000000 }
            ]
          }
        # A+ POST-UPDATE BOUND: new_reserve_out <= 3B (symmetric)
        - { op: "<=",
            args: [
              { op: "-",
                args: [
                  { var: "reserve_out" },
                  { op: "div",
                    args: [
                      { op: "*", args: [{ var: "reserve_out" }, { param: "amount_in" }] },
                      { op: "+", args: [{ var: "reserve_in" }, { param: "amount_in" }] }
                    ]
                  }
                ]
              },
              { const: 3000000000 }
            ]
          }
        # Slippage check
        - { op: ">=",
            args: [
              { op: "div",
                args: [
                  { op: "*", args: [{ var: "reserve_out" }, { param: "amount_in" }] },
                  { op: "+", args: [{ var: "reserve_in" }, { param: "amount_in" }] }
                ]
              },
              { param: "min_amount_out" }
            ]
          }
        # Ensure amount_out > 0
        - { op: ">",
            args: [
              { op: "div",
                args: [
                  { op: "*", args: [{ var: "reserve_out" }, { param: "amount_in" }] },
                  { op: "+", args: [{ var: "reserve_in" }, { param: "amount_in" }] }
                ]
              },
              { const: 0 }
            ]
          }
        # A+ CANNOT DRAIN: amount_out < reserve_out
        - { op: "<",
            args: [
              { op: "div",
                args: [
                  { op: "*", args: [{ var: "reserve_out" }, { param: "amount_in" }] },
                  { op: "+", args: [{ var: "reserve_in" }, { param: "amount_in" }] }
                ]
              },
              { var: "reserve_out" }
            ]
          }
        # A+ CANNOT DRAIN: new_reserve_out >= 1
        - { op: ">=",
            args: [
              { op: "-",
                args: [
                  { var: "reserve_out" },
                  { op: "div",
                    args: [
                      { op: "*", args: [{ var: "reserve_out" }, { param: "amount_in" }] },
                      { op: "+", args: [{ var: "reserve_in" }, { param: "amount_in" }] }
                    ]
                  }
                ]
              },
              { const: 1 }
            ]
          }
        # A+ K-PRESERVED: k_after >= k_before
        - { op: ">=",
            args: [
              # k_after = new_reserve_in * new_reserve_out
              { op: "*",
                args: [
                  { op: "+", args: [{ var: "reserve_in" }, { param: "amount_in" }] },
                  { op: "-",
                    args: [
                      { var: "reserve_out" },
                      { op: "div",
                        args: [
                          { op: "*", args: [{ var: "reserve_out" }, { param: "amount_in" }] },
                          { op: "+", args: [{ var: "reserve_in" }, { param: "amount_in" }] }
                        ]
                      }
                    ]
                  }
                ]
              },
              # k_before = reserve_in * reserve_out
              { op: "*", args: [{ var: "reserve_in" }, { var: "reserve_out" }] }
            ]
          }
    updates:
      - var: "reserve_in_before"
        expr: { var: "reserve_in" }
      - var: "reserve_in"
        expr:
          op: "+"
          args: [{ var: "reserve_in" }, { param: "amount_in" }]
      - var: "reserve_out_before"
        expr: { var: "reserve_out" }
      - var: "reserve_out"
        expr:
          op: "-"
          args:
            - { var: "reserve_out" }
            - op: "div"
              args:
                - { op: "*", args: [{ var: "reserve_out" }, { param: "amount_in" }] }
                - { op: "+", args: [{ var: "reserve_in" }, { param: "amount_in" }] }
    effects:
      amount_out:
        op: "-"
        args: [{ var: "reserve_out_before" }, { var: "reserve_out" }]
      new_reserve_in:
        { var: "reserve_in" }
      new_reserve_out:
        { var: "reserve_out" }
      k_before:
        op: "*"
        args: [{ var: "reserve_in_before" }, { var: "reserve_out_before" }]
      k_after:
        op: "*"
        args: [{ var: "reserve_in" }, { var: "reserve_out" }]
