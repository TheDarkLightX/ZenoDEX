# [FORGE] CPMM Output Amount Calculator (Synthesizable)
ir_version: "esso-ir/v1"
meta:
  model_id: "cpmm_output_amount_hole"
  created_by: "cgs"
  notes: |
    Calculates output amount for CPMM swap: amount_out = reserve_out * net_in / (reserve_in + net_in)
    High ROI: Core DEX math - used in every swap
    This is the critical CPMM formula that must be correct

observables:
  state_vars: []
  effects: ["amount_out"]

types: []

state_vars:
  - id: "dummy"
    role: "data"
    type: { kind: "int", min: 0, max: 0 }

init:
  - var: "dummy"
    expr: { const: 0 }

invariants:
  - id: "inv_dummy_fixed"
    kind: "safety"
    expr: { op: "=", args: [{ var: "dummy" }, { const: 0 }] }

actions:
  - id: "calculate_output"
    params:
      - id: "reserve_in"
        type: { kind: "int", min: 1, max: 1000000 }
      - id: "reserve_out"
        type: { kind: "int", min: 1, max: 1000000 }
      - id: "net_in"
        type: { kind: "int", min: 1, max: 1000000 }
    guard:
      op: "and"
      args:
        - { op: ">", args: [{ param: "reserve_in" }, { const: 0 }] }
        - { op: ">", args: [{ param: "reserve_out" }, { const: 0 }] }
        - { op: ">", args: [{ param: "net_in" }, { const: 0 }] }
        - { op: "<", args: [{ param: "net_in" }, { param: "reserve_in" }] }  # Prevent draining
    updates:
      - var: "dummy"
        expr: { var: "dummy" }
    effects:
      amount_out: { const: 0 }  # HOLE: reserve_out * net_in / (reserve_in + net_in)
