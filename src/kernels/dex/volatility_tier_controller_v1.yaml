# [FORGE] Volatility Tier Controller v1 (minimal, verifiable)
#
# Purpose:
# - Map bounded volatility_bps (0..10000) to a tier (0..3).
# - Fail-closed: if data_ok=false, force tier=3 (halt).
# - Monotone within epoch: if epoch unchanged, tier cannot decrease.
# - Deterministic + bounded: finite-domain ints/bools; no wall-clock time.

ir_version: "esso-ir/v1"
meta:
  model_id: "volatility_tier_controller_v1"
  created_by: "zenodex-rd"
  notes: |
    Minimal tier controller with ordered thresholds and monotone-within-epoch semantics.

    Inputs (observe):
    - epoch (bounded int): batch_epoch / block_height surrogate.
    - volatility_bps (0..10000): bounded volatility score (basis points).
    - data_ok (bool): 1 when volatility signal is valid, else 0 (fail-closed).

    Outputs (effects):
    - tier_out: post-state tier (0..3)
    - fee_mult_bps: fee multiplier in bps-of-base (10000=1x, 20000=2x, 30000=3x)
    - max_trade_bps: trade cap bps-of-reserves (10000=100%, 1000=10%, 0=halt)
    - halt: boolean stop-trading signal (tier==3)

observables:
  state_vars: ["tier", "last_epoch", "t1_bps", "t2_bps", "t3_bps"]
  effects: ["tier_out", "fee_mult_bps", "max_trade_bps", "halt"]

types: []

state_vars:
  - id: "tier"
    role: "data"
    type: { kind: "int", min: 0, max: 3 }

  - id: "last_epoch"
    role: "data"
    type: { kind: "int", min: 0, max: 1000000000 }

  # Thresholds (bps). Must satisfy t1 <= t2 <= t3.
  - id: "t1_bps"
    role: "control"
    type: { kind: "int", min: 0, max: 10000 }
  - id: "t2_bps"
    role: "control"
    type: { kind: "int", min: 0, max: 10000 }
  - id: "t3_bps"
    role: "control"
    type: { kind: "int", min: 0, max: 10000 }

init:
  - var: "tier"
    expr: { const: 0 }
  - var: "last_epoch"
    expr: { const: 0 }
  - var: "t1_bps"
    expr: { const: 3000 }
  - var: "t2_bps"
    expr: { const: 6000 }
  - var: "t3_bps"
    expr: { const: 8000 }

invariants:
  - id: "inv_tier_bounded"
    kind: "safety"
    expr:
      op: "and"
      args:
        - { op: ">=", args: [{ var: "tier" }, { const: 0 }] }
        - { op: "<=", args: [{ var: "tier" }, { const: 3 }] }

  - id: "inv_thresholds_ordered"
    kind: "safety"
    expr:
      op: "and"
      args:
        - { op: "<=", args: [{ var: "t1_bps" }, { var: "t2_bps" }] }
        - { op: "<=", args: [{ var: "t2_bps" }, { var: "t3_bps" }] }

actions:
  - id: "configure"
    params:
      - id: "caller_is_admin"
        type: { kind: "bool" }
      - id: "new_t1_bps"
        type: { kind: "int", min: 0, max: 10000 }
      - id: "new_t2_bps"
        type: { kind: "int", min: 0, max: 10000 }
      - id: "new_t3_bps"
        type: { kind: "int", min: 0, max: 10000 }
    guard:
      op: "and"
      args:
        - { param: "caller_is_admin" }
        - { op: "<=", args: [{ param: "new_t1_bps" }, { param: "new_t2_bps" }] }
        - { op: "<=", args: [{ param: "new_t2_bps" }, { param: "new_t3_bps" }] }
    updates:
      - var: "t1_bps"
        expr: { param: "new_t1_bps" }
      - var: "t2_bps"
        expr: { param: "new_t2_bps" }
      - var: "t3_bps"
        expr: { param: "new_t3_bps" }
    effects:
      tier_out: { var: "tier" }
      fee_mult_bps:
        op: "ite"
        cond: { op: "=", args: [{ var: "tier" }, { const: 0 }] }
        then: { const: 10000 }
        else:
          op: "ite"
          cond: { op: "=", args: [{ var: "tier" }, { const: 1 }] }
          then: { const: 20000 }
          else:
            op: "ite"
            cond: { op: "=", args: [{ var: "tier" }, { const: 2 }] }
            then: { const: 30000 }
            else: { const: 0 }
      max_trade_bps:
        op: "ite"
        cond: { op: "=", args: [{ var: "tier" }, { const: 2 }] }
        then: { const: 1000 }
        else:
          op: "ite"
          cond: { op: "=", args: [{ var: "tier" }, { const: 3 }] }
          then: { const: 0 }
          else: { const: 10000 }
      halt: { op: "=", args: [{ var: "tier" }, { const: 3 }] }

  - id: "observe"
    params:
      - id: "epoch"
        type: { kind: "int", min: 0, max: 1000000000 }
      - id: "volatility_bps"
        type: { kind: "int", min: 0, max: 10000 }
      - id: "data_ok"
        type: { kind: "bool" }
    guard:
      op: ">="
      args: [{ param: "epoch" }, { var: "last_epoch" }]
    updates:
      - var: "last_epoch"
        expr: { param: "epoch" }

      - var: "tier"
        expr:
          # desired_tier := fail-closed tier mapping from (data_ok, volatility_bps, thresholds)
          op: "ite"
          cond: { op: "=", args: [{ param: "epoch" }, { var: "last_epoch" }] }
          then:
            # Same epoch: monotone (no de-escalation)
            op: "ite"
            cond:
              op: ">"
              args:
                - op: "ite"
                  cond: { op: "not", args: [{ param: "data_ok" }] }
                  then: { const: 3 }
                  else:
                    op: "ite"
                    cond: { op: ">=", args: [{ param: "volatility_bps" }, { var: "t3_bps" }] }
                    then: { const: 3 }
                    else:
                      op: "ite"
                      cond: { op: ">=", args: [{ param: "volatility_bps" }, { var: "t2_bps" }] }
                      then: { const: 2 }
                      else:
                        op: "ite"
                        cond: { op: ">=", args: [{ param: "volatility_bps" }, { var: "t1_bps" }] }
                        then: { const: 1 }
                        else: { const: 0 }
                - { var: "tier" }
            then:
              op: "ite"
              cond: { op: "not", args: [{ param: "data_ok" }] }
              then: { const: 3 }
              else:
                op: "ite"
                cond: { op: ">=", args: [{ param: "volatility_bps" }, { var: "t3_bps" }] }
                then: { const: 3 }
                else:
                  op: "ite"
                  cond: { op: ">=", args: [{ param: "volatility_bps" }, { var: "t2_bps" }] }
                  then: { const: 2 }
                  else:
                    op: "ite"
                    cond: { op: ">=", args: [{ param: "volatility_bps" }, { var: "t1_bps" }] }
                    then: { const: 1 }
                    else: { const: 0 }
            else: { var: "tier" }
          else:
            # Epoch advanced: allow de-escalation (tier := desired_tier)
            op: "ite"
            cond: { op: "not", args: [{ param: "data_ok" }] }
            then: { const: 3 }
            else:
              op: "ite"
              cond: { op: ">=", args: [{ param: "volatility_bps" }, { var: "t3_bps" }] }
              then: { const: 3 }
              else:
                op: "ite"
                cond: { op: ">=", args: [{ param: "volatility_bps" }, { var: "t2_bps" }] }
                then: { const: 2 }
                else:
                  op: "ite"
                  cond: { op: ">=", args: [{ param: "volatility_bps" }, { var: "t1_bps" }] }
                  then: { const: 1 }
                  else: { const: 0 }
    effects:
      tier_out: { var: "tier" }
      fee_mult_bps:
        op: "ite"
        cond: { op: "=", args: [{ var: "tier" }, { const: 0 }] }
        then: { const: 10000 }
        else:
          op: "ite"
          cond: { op: "=", args: [{ var: "tier" }, { const: 1 }] }
          then: { const: 20000 }
          else:
            op: "ite"
            cond: { op: "=", args: [{ var: "tier" }, { const: 2 }] }
            then: { const: 30000 }
            else: { const: 0 }
      max_trade_bps:
        op: "ite"
        cond: { op: "=", args: [{ var: "tier" }, { const: 2 }] }
        then: { const: 1000 }
        else:
          op: "ite"
          cond: { op: "=", args: [{ var: "tier" }, { const: 3 }] }
          then: { const: 0 }
          else: { const: 10000 }
      halt: { op: "=", args: [{ var: "tier" }, { const: 3 }] }

