"""
Auto-generated Python reference model for: perp_epoch_isolated_v2
IR hash: sha256:fda07ba1e3a9d0fe279a0986fdda2bac433133e8c948a4f62af3102294348cf3

Generated from the YAML kernel spec by the repo's optional private toolchain.

This file is standalone and has no runtime dependency on the generator/toolchain.
"""

from __future__ import annotations

from dataclasses import dataclass
from typing import Any, Literal, Mapping


@dataclass(frozen=True)
class State:
    """Model state."""

    breaker_active: bool
    breaker_last_trigger_epoch: int
    claims_paid: int
    clearing_price_e8: int
    clearing_price_epoch: int
    clearing_price_seen: bool
    collateral_quote: int
    depeg_buffer_bps: int
    entry_price_e8: int
    fee_income: int
    fee_pool_quote: int
    funding_cap_bps: int
    funding_last_applied_epoch: int
    funding_paid_cumulative: int
    funding_rate_bps: int
    index_price_e8: int
    initial_insurance: int
    initial_margin_bps: int
    insurance_balance: int
    liquidated_this_step: bool
    liquidation_penalty_bps: int
    maintenance_margin_bps: int
    max_oracle_move_bps: int
    max_oracle_staleness_epochs: int
    max_position_abs: int
    min_notional_for_bounty: int
    now_epoch: int
    oracle_last_update_epoch: int
    oracle_seen: bool
    position_base: int


@dataclass(frozen=True)
class Command:
    """Command to execute."""

    tag: Literal(
        "advance_epoch",
        "apply_funding",
        "apply_insurance_claim",
        "clear_breaker",
        "deposit_collateral",
        "deposit_insurance",
        "publish_clearing_price",
        "set_position",
        "settle_epoch",
        "withdraw_collateral",
    )
    args: Mapping[str, Any]


@dataclass(frozen=True)
class StepResult:
    """Result of a step execution."""

    ok: bool
    state: State | None = None
    effects: Mapping[str, Any] | None = None
    error: str | None = None


def init_state() -> State:
    """Return the initial state."""
    return State(
        breaker_active=False,
        breaker_last_trigger_epoch=0,
        claims_paid=0,
        clearing_price_e8=0,
        clearing_price_epoch=0,
        clearing_price_seen=False,
        collateral_quote=0,
        depeg_buffer_bps=100,
        entry_price_e8=0,
        fee_income=0,
        fee_pool_quote=0,
        funding_cap_bps=100,
        funding_last_applied_epoch=0,
        funding_paid_cumulative=0,
        funding_rate_bps=0,
        index_price_e8=0,
        initial_insurance=0,
        initial_margin_bps=1000,
        insurance_balance=0,
        liquidated_this_step=False,
        liquidation_penalty_bps=50,
        maintenance_margin_bps=500,
        max_oracle_move_bps=500,
        max_oracle_staleness_epochs=100,
        max_position_abs=1000000,
        min_notional_for_bounty=100000000,
        now_epoch=0,
        oracle_last_update_epoch=0,
        oracle_seen=False,
        position_base=0,
    )


def check_invariants(s: State) -> tuple[bool, str | None]:
    """Check all invariants. Returns (ok, first_failed_id)."""
    if not (isinstance(s.breaker_active, bool)):
        return False, "domain_breaker_active"
    if not (
        isinstance(s.breaker_last_trigger_epoch, int)
        and not isinstance(s.breaker_last_trigger_epoch, bool)
        and 0 <= s.breaker_last_trigger_epoch <= 1000000
    ):
        return False, "domain_breaker_last_trigger_epoch"
    if not (
        isinstance(s.claims_paid, int)
        and not isinstance(s.claims_paid, bool)
        and 0 <= s.claims_paid <= 1000000000000000
    ):
        return False, "domain_claims_paid"
    if not (
        isinstance(s.clearing_price_e8, int)
        and not isinstance(s.clearing_price_e8, bool)
        and 0 <= s.clearing_price_e8 <= 1000000000000
    ):
        return False, "domain_clearing_price_e8"
    if not (
        isinstance(s.clearing_price_epoch, int)
        and not isinstance(s.clearing_price_epoch, bool)
        and 0 <= s.clearing_price_epoch <= 1000000
    ):
        return False, "domain_clearing_price_epoch"
    if not (isinstance(s.clearing_price_seen, bool)):
        return False, "domain_clearing_price_seen"
    if not (
        isinstance(s.collateral_quote, int)
        and not isinstance(s.collateral_quote, bool)
        and 0 <= s.collateral_quote <= 1000000000000000
    ):
        return False, "domain_collateral_quote"
    if not (
        isinstance(s.depeg_buffer_bps, int)
        and not isinstance(s.depeg_buffer_bps, bool)
        and 0 <= s.depeg_buffer_bps <= 5000
    ):
        return False, "domain_depeg_buffer_bps"
    if not (
        isinstance(s.entry_price_e8, int)
        and not isinstance(s.entry_price_e8, bool)
        and 0 <= s.entry_price_e8 <= 1000000000000
    ):
        return False, "domain_entry_price_e8"
    if not (
        isinstance(s.fee_income, int)
        and not isinstance(s.fee_income, bool)
        and 0 <= s.fee_income <= 1000000000000000
    ):
        return False, "domain_fee_income"
    if not (
        isinstance(s.fee_pool_quote, int)
        and not isinstance(s.fee_pool_quote, bool)
        and 0 <= s.fee_pool_quote <= 1000000000000000
    ):
        return False, "domain_fee_pool_quote"
    if not (
        isinstance(s.funding_cap_bps, int)
        and not isinstance(s.funding_cap_bps, bool)
        and 1 <= s.funding_cap_bps <= 10000
    ):
        return False, "domain_funding_cap_bps"
    if not (
        isinstance(s.funding_last_applied_epoch, int)
        and not isinstance(s.funding_last_applied_epoch, bool)
        and 0 <= s.funding_last_applied_epoch <= 1000000
    ):
        return False, "domain_funding_last_applied_epoch"
    if not (
        isinstance(s.funding_paid_cumulative, int)
        and not isinstance(s.funding_paid_cumulative, bool)
        and -1000000000000000 <= s.funding_paid_cumulative <= 1000000000000000
    ):
        return False, "domain_funding_paid_cumulative"
    if not (
        isinstance(s.funding_rate_bps, int)
        and not isinstance(s.funding_rate_bps, bool)
        and -10000 <= s.funding_rate_bps <= 10000
    ):
        return False, "domain_funding_rate_bps"
    if not (
        isinstance(s.index_price_e8, int)
        and not isinstance(s.index_price_e8, bool)
        and 0 <= s.index_price_e8 <= 1000000000000
    ):
        return False, "domain_index_price_e8"
    if not (
        isinstance(s.initial_insurance, int)
        and not isinstance(s.initial_insurance, bool)
        and 0 <= s.initial_insurance <= 1000000000000000
    ):
        return False, "domain_initial_insurance"
    if not (
        isinstance(s.initial_margin_bps, int)
        and not isinstance(s.initial_margin_bps, bool)
        and 0 <= s.initial_margin_bps <= 10000
    ):
        return False, "domain_initial_margin_bps"
    if not (
        isinstance(s.insurance_balance, int)
        and not isinstance(s.insurance_balance, bool)
        and 0 <= s.insurance_balance <= 1000000000000000
    ):
        return False, "domain_insurance_balance"
    if not (isinstance(s.liquidated_this_step, bool)):
        return False, "domain_liquidated_this_step"
    if not (
        isinstance(s.liquidation_penalty_bps, int)
        and not isinstance(s.liquidation_penalty_bps, bool)
        and 0 <= s.liquidation_penalty_bps <= 10000
    ):
        return False, "domain_liquidation_penalty_bps"
    if not (
        isinstance(s.maintenance_margin_bps, int)
        and not isinstance(s.maintenance_margin_bps, bool)
        and 0 <= s.maintenance_margin_bps <= 10000
    ):
        return False, "domain_maintenance_margin_bps"
    if not (
        isinstance(s.max_oracle_move_bps, int)
        and not isinstance(s.max_oracle_move_bps, bool)
        and 0 <= s.max_oracle_move_bps <= 10000
    ):
        return False, "domain_max_oracle_move_bps"
    if not (
        isinstance(s.max_oracle_staleness_epochs, int)
        and not isinstance(s.max_oracle_staleness_epochs, bool)
        and 1 <= s.max_oracle_staleness_epochs <= 1000000
    ):
        return False, "domain_max_oracle_staleness_epochs"
    if not (
        isinstance(s.max_position_abs, int)
        and not isinstance(s.max_position_abs, bool)
        and 1 <= s.max_position_abs <= 1000000
    ):
        return False, "domain_max_position_abs"
    if not (
        isinstance(s.min_notional_for_bounty, int)
        and not isinstance(s.min_notional_for_bounty, bool)
        and 0 <= s.min_notional_for_bounty <= 1000000000000
    ):
        return False, "domain_min_notional_for_bounty"
    if not (
        isinstance(s.now_epoch, int)
        and not isinstance(s.now_epoch, bool)
        and 0 <= s.now_epoch <= 1000000
    ):
        return False, "domain_now_epoch"
    if not (
        isinstance(s.oracle_last_update_epoch, int)
        and not isinstance(s.oracle_last_update_epoch, bool)
        and 0 <= s.oracle_last_update_epoch <= 1000000
    ):
        return False, "domain_oracle_last_update_epoch"
    if not (isinstance(s.oracle_seen, bool)):
        return False, "domain_oracle_seen"
    if not (
        isinstance(s.position_base, int)
        and not isinstance(s.position_base, bool)
        and -1000000 <= s.position_base <= 1000000
    ):
        return False, "domain_position_base"
    if not ((not (not s.breaker_active)) or (0 == s.breaker_last_trigger_epoch)):
        return False, "inv_breaker_inactive_zeroed"
    if not (s.breaker_last_trigger_epoch <= s.now_epoch):
        return False, "inv_breaker_not_from_future"
    if not (s.clearing_price_epoch <= s.now_epoch):
        return False, "inv_clearing_not_from_future"
    if not (
        (not (not s.clearing_price_seen))
        or ((0 == s.clearing_price_e8) and (0 == s.clearing_price_epoch))
    ):
        return False, "inv_clearing_seen_zeroed"
    if not (
        (not (not (0 == s.position_base))) or (s.entry_price_e8 == s.index_price_e8)
    ):
        return False, "inv_entry_matches_price_when_open"
    if not ((not (0 == s.position_base)) or (0 == s.entry_price_e8)):
        return False, "inv_entry_zero_when_flat"
    if not (s.fee_income == s.fee_pool_quote):
        return False, "inv_fee_pool_eq_fee_income"
    if not (
        ((0 - s.funding_cap_bps) <= s.funding_rate_bps)
        and (s.funding_rate_bps <= s.funding_cap_bps)
    ):
        return False, "inv_funding_bounded"
    if not (s.funding_last_applied_epoch <= s.now_epoch):
        return False, "inv_funding_epoch_gated"
    if not (
        ((s.fee_income + s.initial_insurance) - s.claims_paid) == s.insurance_balance
    ):
        return False, "inv_insurance_conservation"
    if not (s.insurance_balance >= 0):
        return False, "inv_insurance_nonneg"
    if not (
        s.liquidation_penalty_bps < (s.depeg_buffer_bps + s.maintenance_margin_bps)
    ):
        return False, "inv_liquidation_ic_guard"
    if not (
        (not (not (0 == s.position_base)))
        or (
            s.collateral_quote
            >= (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (s.depeg_buffer_bps + s.maintenance_margin_bps)
                            * (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                s.position_base
                                                if (s.position_base >= 0)
                                                else (0 - s.position_base)
                                            )
                                            * s.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                                * s.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (s.depeg_buffer_bps + s.maintenance_margin_bps)
                                * (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                                * s.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                    * s.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            )
        )
    ):
        return False, "inv_maint_margin_ok"
    if not (
        ((s.depeg_buffer_bps + s.maintenance_margin_bps) <= s.initial_margin_bps)
        and (s.max_oracle_move_bps <= (s.depeg_buffer_bps + s.maintenance_margin_bps))
    ):
        return False, "inv_margin_params_ordered"
    if not (s.oracle_last_update_epoch <= s.now_epoch):
        return False, "inv_oracle_not_from_future"
    if not (
        (not (not s.oracle_seen))
        or ((0 == s.index_price_e8) and (0 == s.oracle_last_update_epoch))
    ):
        return False, "inv_oracle_seen_zeroed"
    return True, None


def step(s: State, cmd: Command) -> StepResult:
    """Execute a step. Returns StepResult."""
    # Check pre-state invariants
    ok, failed = check_invariants(s)
    if not ok:
        return StepResult(ok=False, error=f"pre-invariant violated: {failed}")

    if cmd.tag == "advance_epoch":
        if "delta" not in cmd.args or not (
            isinstance(cmd.args["delta"], int)
            and not isinstance(cmd.args["delta"], bool)
            and 1 <= cmd.args["delta"] <= 10000
        ):
            return StepResult(ok=False, error="invalid param delta")
        if not ((cmd.args["delta"] + s.now_epoch) <= 1000000):
            return StepResult(ok=False, error="guard failed for advance_epoch")
        # Compute updates (simultaneous)
        new_state = State(
            breaker_active=s.breaker_active,
            breaker_last_trigger_epoch=s.breaker_last_trigger_epoch,
            claims_paid=s.claims_paid,
            clearing_price_e8=s.clearing_price_e8,
            clearing_price_epoch=s.clearing_price_epoch,
            clearing_price_seen=s.clearing_price_seen,
            collateral_quote=s.collateral_quote,
            depeg_buffer_bps=s.depeg_buffer_bps,
            entry_price_e8=s.entry_price_e8,
            fee_income=s.fee_income,
            fee_pool_quote=s.fee_pool_quote,
            funding_cap_bps=s.funding_cap_bps,
            funding_last_applied_epoch=s.funding_last_applied_epoch,
            funding_paid_cumulative=s.funding_paid_cumulative,
            funding_rate_bps=s.funding_rate_bps,
            index_price_e8=s.index_price_e8,
            initial_insurance=s.initial_insurance,
            initial_margin_bps=s.initial_margin_bps,
            insurance_balance=s.insurance_balance,
            liquidated_this_step=False,
            liquidation_penalty_bps=s.liquidation_penalty_bps,
            maintenance_margin_bps=s.maintenance_margin_bps,
            max_oracle_move_bps=s.max_oracle_move_bps,
            max_oracle_staleness_epochs=s.max_oracle_staleness_epochs,
            max_position_abs=s.max_position_abs,
            min_notional_for_bounty=s.min_notional_for_bounty,
            now_epoch=(cmd.args["delta"] + s.now_epoch),
            oracle_last_update_epoch=s.oracle_last_update_epoch,
            oracle_seen=s.oracle_seen,
            position_base=s.position_base,
        )
        effects = {
            "collateral_after": new_state.collateral_quote,
            "effective_maint_bps": (
                new_state.depeg_buffer_bps + new_state.maintenance_margin_bps
            ),
            "event": "EpochAdvanced",
            "fee_pool_after": new_state.fee_pool_quote,
            "init_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            * new_state.initial_margin_bps
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                * new_state.initial_margin_bps
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "insurance_after": new_state.insurance_balance,
            "liquidated": new_state.liquidated_this_step,
            "maint_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                new_state.depeg_buffer_bps
                                + new_state.maintenance_margin_bps
                            )
                            * (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.depeg_buffer_bps
                                    + new_state.maintenance_margin_bps
                                )
                                * (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "margin_ok": (
                True
                if (0 == new_state.position_base)
                else (
                    new_state.collateral_quote
                    >= (
                        0
                        if 10000 == 0
                        else (
                            (
                                (
                                    (
                                        new_state.depeg_buffer_bps
                                        + new_state.maintenance_margin_bps
                                    )
                                    * (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                                // 10000
                            )
                            + (
                                1
                                if (
                                    (
                                        (
                                            new_state.depeg_buffer_bps
                                            + new_state.maintenance_margin_bps
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                new_state.position_base
                                                                if (
                                                                    new_state.position_base
                                                                    >= 0
                                                                )
                                                                else (
                                                                    0
                                                                    - new_state.position_base
                                                                )
                                                            )
                                                            * new_state.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    % 10000
                                )
                                < 0
                                else 0
                            )
                        )
                    )
                )
            ),
            "notional_quote": (
                0
                if 100000000 == 0
                else (
                    (
                        (
                            (
                                new_state.position_base
                                if (new_state.position_base >= 0)
                                else (0 - new_state.position_base)
                            )
                            * new_state.index_price_e8
                        )
                        // 100000000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.position_base
                                    if (new_state.position_base >= 0)
                                    else (0 - new_state.position_base)
                                )
                                * new_state.index_price_e8
                            )
                            % 100000000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "oracle_fresh": (
                (
                    (new_state.now_epoch - new_state.oracle_last_update_epoch)
                    <= new_state.max_oracle_staleness_epochs
                )
                and new_state.oracle_seen
            ),
        }
        ok, failed = check_invariants(new_state)
        if not ok:
            return StepResult(ok=False, error=f"post-invariant violated: {failed}")
        return StepResult(ok=True, state=new_state, effects=effects)
    elif cmd.tag == "apply_funding":
        if "new_rate_bps" not in cmd.args or not (
            isinstance(cmd.args["new_rate_bps"], int)
            and not isinstance(cmd.args["new_rate_bps"], bool)
            and -10000 <= cmd.args["new_rate_bps"] <= 10000
        ):
            return StepResult(ok=False, error="invalid param new_rate_bps")
        if "auth_ok" not in cmd.args or not (isinstance(cmd.args["auth_ok"], bool)):
            return StepResult(ok=False, error="invalid param auth_ok")
        if not (
            (s.funding_last_applied_epoch < s.now_epoch)
            and (
                (
                    (
                        (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (
                                        (
                                            cmd.args["new_rate_bps"]
                                            if (cmd.args["new_rate_bps"] >= 0)
                                            else (0 - cmd.args["new_rate_bps"])
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * s.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                cmd.args["new_rate_bps"]
                                                if (cmd.args["new_rate_bps"] >= 0)
                                                else (0 - cmd.args["new_rate_bps"])
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                        if ((cmd.args["new_rate_bps"] >= 0) == (s.position_base >= 0))
                        else (
                            0
                            - (
                                0
                                if 10000 == 0
                                else (
                                    (
                                        (
                                            (
                                                cmd.args["new_rate_bps"]
                                                if (cmd.args["new_rate_bps"] >= 0)
                                                else (0 - cmd.args["new_rate_bps"])
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        // 10000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    cmd.args["new_rate_bps"]
                                                    if (cmd.args["new_rate_bps"] >= 0)
                                                    else (0 - cmd.args["new_rate_bps"])
                                                )
                                                * (
                                                    0
                                                    if 100000000 == 0
                                                    else (
                                                        (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            // 100000000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                    * s.index_price_e8
                                                                )
                                                                % 100000000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                            )
                                            % 10000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                    )
                    + s.funding_paid_cumulative
                )
                <= 1000000000000000
            )
            and ((0 - s.funding_cap_bps) <= cmd.args["new_rate_bps"])
            and (
                (
                    s.collateral_quote
                    - (
                        (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (
                                        (
                                            cmd.args["new_rate_bps"]
                                            if (cmd.args["new_rate_bps"] >= 0)
                                            else (0 - cmd.args["new_rate_bps"])
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * s.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                cmd.args["new_rate_bps"]
                                                if (cmd.args["new_rate_bps"] >= 0)
                                                else (0 - cmd.args["new_rate_bps"])
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                        if ((cmd.args["new_rate_bps"] >= 0) == (s.position_base >= 0))
                        else (
                            0
                            - (
                                0
                                if 10000 == 0
                                else (
                                    (
                                        (
                                            (
                                                cmd.args["new_rate_bps"]
                                                if (cmd.args["new_rate_bps"] >= 0)
                                                else (0 - cmd.args["new_rate_bps"])
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        // 10000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    cmd.args["new_rate_bps"]
                                                    if (cmd.args["new_rate_bps"] >= 0)
                                                    else (0 - cmd.args["new_rate_bps"])
                                                )
                                                * (
                                                    0
                                                    if 100000000 == 0
                                                    else (
                                                        (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            // 100000000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                    * s.index_price_e8
                                                                )
                                                                % 100000000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                            )
                                            % 10000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                    )
                )
                <= 1000000000000000
            )
            and (
                (s.now_epoch - s.oracle_last_update_epoch)
                <= s.max_oracle_staleness_epochs
            )
            and (cmd.args["new_rate_bps"] <= s.funding_cap_bps)
            and (True == cmd.args["auth_ok"])
            and (
                (
                    (
                        (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (
                                        (
                                            cmd.args["new_rate_bps"]
                                            if (cmd.args["new_rate_bps"] >= 0)
                                            else (0 - cmd.args["new_rate_bps"])
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * s.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                cmd.args["new_rate_bps"]
                                                if (cmd.args["new_rate_bps"] >= 0)
                                                else (0 - cmd.args["new_rate_bps"])
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                        if ((cmd.args["new_rate_bps"] >= 0) == (s.position_base >= 0))
                        else (
                            0
                            - (
                                0
                                if 10000 == 0
                                else (
                                    (
                                        (
                                            (
                                                cmd.args["new_rate_bps"]
                                                if (cmd.args["new_rate_bps"] >= 0)
                                                else (0 - cmd.args["new_rate_bps"])
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        // 10000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    cmd.args["new_rate_bps"]
                                                    if (cmd.args["new_rate_bps"] >= 0)
                                                    else (0 - cmd.args["new_rate_bps"])
                                                )
                                                * (
                                                    0
                                                    if 100000000 == 0
                                                    else (
                                                        (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            // 100000000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                    * s.index_price_e8
                                                                )
                                                                % 100000000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                            )
                                            % 10000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                    )
                    + s.funding_paid_cumulative
                )
                >= -1000000000000000
            )
            and (
                (
                    s.collateral_quote
                    - (
                        (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (
                                        (
                                            cmd.args["new_rate_bps"]
                                            if (cmd.args["new_rate_bps"] >= 0)
                                            else (0 - cmd.args["new_rate_bps"])
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * s.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                cmd.args["new_rate_bps"]
                                                if (cmd.args["new_rate_bps"] >= 0)
                                                else (0 - cmd.args["new_rate_bps"])
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                        if ((cmd.args["new_rate_bps"] >= 0) == (s.position_base >= 0))
                        else (
                            0
                            - (
                                0
                                if 10000 == 0
                                else (
                                    (
                                        (
                                            (
                                                cmd.args["new_rate_bps"]
                                                if (cmd.args["new_rate_bps"] >= 0)
                                                else (0 - cmd.args["new_rate_bps"])
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        // 10000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    cmd.args["new_rate_bps"]
                                                    if (cmd.args["new_rate_bps"] >= 0)
                                                    else (0 - cmd.args["new_rate_bps"])
                                                )
                                                * (
                                                    0
                                                    if 100000000 == 0
                                                    else (
                                                        (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            // 100000000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                    * s.index_price_e8
                                                                )
                                                                % 100000000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                            )
                                            % 10000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                    )
                )
                >= 0
            )
            and (
                (
                    s.collateral_quote
                    - (
                        (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (
                                        (
                                            cmd.args["new_rate_bps"]
                                            if (cmd.args["new_rate_bps"] >= 0)
                                            else (0 - cmd.args["new_rate_bps"])
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * s.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                cmd.args["new_rate_bps"]
                                                if (cmd.args["new_rate_bps"] >= 0)
                                                else (0 - cmd.args["new_rate_bps"])
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                        if ((cmd.args["new_rate_bps"] >= 0) == (s.position_base >= 0))
                        else (
                            0
                            - (
                                0
                                if 10000 == 0
                                else (
                                    (
                                        (
                                            (
                                                cmd.args["new_rate_bps"]
                                                if (cmd.args["new_rate_bps"] >= 0)
                                                else (0 - cmd.args["new_rate_bps"])
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        // 10000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    cmd.args["new_rate_bps"]
                                                    if (cmd.args["new_rate_bps"] >= 0)
                                                    else (0 - cmd.args["new_rate_bps"])
                                                )
                                                * (
                                                    0
                                                    if 100000000 == 0
                                                    else (
                                                        (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            // 100000000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                    * s.index_price_e8
                                                                )
                                                                % 100000000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                            )
                                            % 10000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                    )
                )
                >= (
                    0
                    if 10000 == 0
                    else (
                        (
                            (
                                (s.depeg_buffer_bps + s.maintenance_margin_bps)
                                * (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                                * s.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                    * s.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                            )
                            // 10000
                        )
                        + (
                            1
                            if (
                                (
                                    (s.depeg_buffer_bps + s.maintenance_margin_bps)
                                    * (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                    * s.index_price_e8
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * s.index_price_e8
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                                % 10000
                            )
                            < 0
                            else 0
                        )
                    )
                )
            )
            and (not (0 == s.position_base))
            and s.oracle_seen
        ):
            return StepResult(ok=False, error="guard failed for apply_funding")
        # Compute updates (simultaneous)
        new_state = State(
            breaker_active=s.breaker_active,
            breaker_last_trigger_epoch=s.breaker_last_trigger_epoch,
            claims_paid=s.claims_paid,
            clearing_price_e8=s.clearing_price_e8,
            clearing_price_epoch=s.clearing_price_epoch,
            clearing_price_seen=s.clearing_price_seen,
            collateral_quote=(
                s.collateral_quote
                - (
                    (
                        0
                        if 10000 == 0
                        else (
                            (
                                (
                                    (
                                        cmd.args["new_rate_bps"]
                                        if (cmd.args["new_rate_bps"] >= 0)
                                        else (0 - cmd.args["new_rate_bps"])
                                    )
                                    * (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                    * s.index_price_e8
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * s.index_price_e8
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                                // 10000
                            )
                            + (
                                1
                                if (
                                    (
                                        (
                                            cmd.args["new_rate_bps"]
                                            if (cmd.args["new_rate_bps"] >= 0)
                                            else (0 - cmd.args["new_rate_bps"])
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * s.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    % 10000
                                )
                                < 0
                                else 0
                            )
                        )
                    )
                    if ((cmd.args["new_rate_bps"] >= 0) == (s.position_base >= 0))
                    else (
                        0
                        - (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (
                                        (
                                            cmd.args["new_rate_bps"]
                                            if (cmd.args["new_rate_bps"] >= 0)
                                            else (0 - cmd.args["new_rate_bps"])
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * s.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                cmd.args["new_rate_bps"]
                                                if (cmd.args["new_rate_bps"] >= 0)
                                                else (0 - cmd.args["new_rate_bps"])
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                    )
                )
            ),
            depeg_buffer_bps=s.depeg_buffer_bps,
            entry_price_e8=s.entry_price_e8,
            fee_income=s.fee_income,
            fee_pool_quote=s.fee_pool_quote,
            funding_cap_bps=s.funding_cap_bps,
            funding_last_applied_epoch=s.now_epoch,
            funding_paid_cumulative=(
                (
                    (
                        0
                        if 10000 == 0
                        else (
                            (
                                (
                                    (
                                        cmd.args["new_rate_bps"]
                                        if (cmd.args["new_rate_bps"] >= 0)
                                        else (0 - cmd.args["new_rate_bps"])
                                    )
                                    * (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                    * s.index_price_e8
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * s.index_price_e8
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                                // 10000
                            )
                            + (
                                1
                                if (
                                    (
                                        (
                                            cmd.args["new_rate_bps"]
                                            if (cmd.args["new_rate_bps"] >= 0)
                                            else (0 - cmd.args["new_rate_bps"])
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * s.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    % 10000
                                )
                                < 0
                                else 0
                            )
                        )
                    )
                    if ((cmd.args["new_rate_bps"] >= 0) == (s.position_base >= 0))
                    else (
                        0
                        - (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (
                                        (
                                            cmd.args["new_rate_bps"]
                                            if (cmd.args["new_rate_bps"] >= 0)
                                            else (0 - cmd.args["new_rate_bps"])
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * s.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                cmd.args["new_rate_bps"]
                                                if (cmd.args["new_rate_bps"] >= 0)
                                                else (0 - cmd.args["new_rate_bps"])
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                    )
                )
                + s.funding_paid_cumulative
            ),
            funding_rate_bps=cmd.args["new_rate_bps"],
            index_price_e8=s.index_price_e8,
            initial_insurance=s.initial_insurance,
            initial_margin_bps=s.initial_margin_bps,
            insurance_balance=s.insurance_balance,
            liquidated_this_step=False,
            liquidation_penalty_bps=s.liquidation_penalty_bps,
            maintenance_margin_bps=s.maintenance_margin_bps,
            max_oracle_move_bps=s.max_oracle_move_bps,
            max_oracle_staleness_epochs=s.max_oracle_staleness_epochs,
            max_position_abs=s.max_position_abs,
            min_notional_for_bounty=s.min_notional_for_bounty,
            now_epoch=s.now_epoch,
            oracle_last_update_epoch=s.oracle_last_update_epoch,
            oracle_seen=s.oracle_seen,
            position_base=s.position_base,
        )
        effects = {
            "collateral_after": new_state.collateral_quote,
            "effective_maint_bps": (
                new_state.depeg_buffer_bps + new_state.maintenance_margin_bps
            ),
            "event": "FundingApplied",
            "fee_pool_after": new_state.fee_pool_quote,
            "init_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            * new_state.initial_margin_bps
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                * new_state.initial_margin_bps
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "insurance_after": new_state.insurance_balance,
            "liquidated": new_state.liquidated_this_step,
            "maint_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                new_state.depeg_buffer_bps
                                + new_state.maintenance_margin_bps
                            )
                            * (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.depeg_buffer_bps
                                    + new_state.maintenance_margin_bps
                                )
                                * (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "margin_ok": (
                True
                if (0 == new_state.position_base)
                else (
                    new_state.collateral_quote
                    >= (
                        0
                        if 10000 == 0
                        else (
                            (
                                (
                                    (
                                        new_state.depeg_buffer_bps
                                        + new_state.maintenance_margin_bps
                                    )
                                    * (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                                // 10000
                            )
                            + (
                                1
                                if (
                                    (
                                        (
                                            new_state.depeg_buffer_bps
                                            + new_state.maintenance_margin_bps
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                new_state.position_base
                                                                if (
                                                                    new_state.position_base
                                                                    >= 0
                                                                )
                                                                else (
                                                                    0
                                                                    - new_state.position_base
                                                                )
                                                            )
                                                            * new_state.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    % 10000
                                )
                                < 0
                                else 0
                            )
                        )
                    )
                )
            ),
            "notional_quote": (
                0
                if 100000000 == 0
                else (
                    (
                        (
                            (
                                new_state.position_base
                                if (new_state.position_base >= 0)
                                else (0 - new_state.position_base)
                            )
                            * new_state.index_price_e8
                        )
                        // 100000000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.position_base
                                    if (new_state.position_base >= 0)
                                    else (0 - new_state.position_base)
                                )
                                * new_state.index_price_e8
                            )
                            % 100000000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "oracle_fresh": (
                (
                    (new_state.now_epoch - new_state.oracle_last_update_epoch)
                    <= new_state.max_oracle_staleness_epochs
                )
                and new_state.oracle_seen
            ),
        }
        ok, failed = check_invariants(new_state)
        if not ok:
            return StepResult(ok=False, error=f"post-invariant violated: {failed}")
        return StepResult(ok=True, state=new_state, effects=effects)
    elif cmd.tag == "apply_insurance_claim":
        if "claim_amount" not in cmd.args or not (
            isinstance(cmd.args["claim_amount"], int)
            and not isinstance(cmd.args["claim_amount"], bool)
            and 1 <= cmd.args["claim_amount"] <= 1000000000000
        ):
            return StepResult(ok=False, error="invalid param claim_amount")
        if "auth_ok" not in cmd.args or not (isinstance(cmd.args["auth_ok"], bool)):
            return StepResult(ok=False, error="invalid param auth_ok")
        if not (
            ((cmd.args["claim_amount"] + s.claims_paid) <= 1000000000000000)
            and (cmd.args["claim_amount"] <= s.insurance_balance)
            and (True == cmd.args["auth_ok"])
            and (
                (
                    (s.fee_income + s.initial_insurance)
                    - (cmd.args["claim_amount"] + s.claims_paid)
                )
                >= 0
            )
        ):
            return StepResult(ok=False, error="guard failed for apply_insurance_claim")
        # Compute updates (simultaneous)
        new_state = State(
            breaker_active=s.breaker_active,
            breaker_last_trigger_epoch=s.breaker_last_trigger_epoch,
            claims_paid=(cmd.args["claim_amount"] + s.claims_paid),
            clearing_price_e8=s.clearing_price_e8,
            clearing_price_epoch=s.clearing_price_epoch,
            clearing_price_seen=s.clearing_price_seen,
            collateral_quote=s.collateral_quote,
            depeg_buffer_bps=s.depeg_buffer_bps,
            entry_price_e8=s.entry_price_e8,
            fee_income=s.fee_income,
            fee_pool_quote=s.fee_pool_quote,
            funding_cap_bps=s.funding_cap_bps,
            funding_last_applied_epoch=s.funding_last_applied_epoch,
            funding_paid_cumulative=s.funding_paid_cumulative,
            funding_rate_bps=s.funding_rate_bps,
            index_price_e8=s.index_price_e8,
            initial_insurance=s.initial_insurance,
            initial_margin_bps=s.initial_margin_bps,
            insurance_balance=(
                (s.fee_income + s.initial_insurance)
                - (cmd.args["claim_amount"] + s.claims_paid)
            ),
            liquidated_this_step=False,
            liquidation_penalty_bps=s.liquidation_penalty_bps,
            maintenance_margin_bps=s.maintenance_margin_bps,
            max_oracle_move_bps=s.max_oracle_move_bps,
            max_oracle_staleness_epochs=s.max_oracle_staleness_epochs,
            max_position_abs=s.max_position_abs,
            min_notional_for_bounty=s.min_notional_for_bounty,
            now_epoch=s.now_epoch,
            oracle_last_update_epoch=s.oracle_last_update_epoch,
            oracle_seen=s.oracle_seen,
            position_base=s.position_base,
        )
        effects = {
            "collateral_after": new_state.collateral_quote,
            "effective_maint_bps": (
                new_state.depeg_buffer_bps + new_state.maintenance_margin_bps
            ),
            "event": "InsuranceClaimPaid",
            "fee_pool_after": new_state.fee_pool_quote,
            "init_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            * new_state.initial_margin_bps
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                * new_state.initial_margin_bps
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "insurance_after": new_state.insurance_balance,
            "liquidated": new_state.liquidated_this_step,
            "maint_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                new_state.depeg_buffer_bps
                                + new_state.maintenance_margin_bps
                            )
                            * (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.depeg_buffer_bps
                                    + new_state.maintenance_margin_bps
                                )
                                * (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "margin_ok": (
                True
                if (0 == new_state.position_base)
                else (
                    new_state.collateral_quote
                    >= (
                        0
                        if 10000 == 0
                        else (
                            (
                                (
                                    (
                                        new_state.depeg_buffer_bps
                                        + new_state.maintenance_margin_bps
                                    )
                                    * (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                                // 10000
                            )
                            + (
                                1
                                if (
                                    (
                                        (
                                            new_state.depeg_buffer_bps
                                            + new_state.maintenance_margin_bps
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                new_state.position_base
                                                                if (
                                                                    new_state.position_base
                                                                    >= 0
                                                                )
                                                                else (
                                                                    0
                                                                    - new_state.position_base
                                                                )
                                                            )
                                                            * new_state.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    % 10000
                                )
                                < 0
                                else 0
                            )
                        )
                    )
                )
            ),
            "notional_quote": (
                0
                if 100000000 == 0
                else (
                    (
                        (
                            (
                                new_state.position_base
                                if (new_state.position_base >= 0)
                                else (0 - new_state.position_base)
                            )
                            * new_state.index_price_e8
                        )
                        // 100000000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.position_base
                                    if (new_state.position_base >= 0)
                                    else (0 - new_state.position_base)
                                )
                                * new_state.index_price_e8
                            )
                            % 100000000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "oracle_fresh": (
                (
                    (new_state.now_epoch - new_state.oracle_last_update_epoch)
                    <= new_state.max_oracle_staleness_epochs
                )
                and new_state.oracle_seen
            ),
        }
        ok, failed = check_invariants(new_state)
        if not ok:
            return StepResult(ok=False, error=f"post-invariant violated: {failed}")
        return StepResult(ok=True, state=new_state, effects=effects)
    elif cmd.tag == "clear_breaker":
        if "auth_ok" not in cmd.args or not (isinstance(cmd.args["auth_ok"], bool)):
            return StepResult(ok=False, error="invalid param auth_ok")
        if not (
            (True == cmd.args["auth_ok"])
            and (0 == s.position_base)
            and s.breaker_active
        ):
            return StepResult(ok=False, error="guard failed for clear_breaker")
        # Compute updates (simultaneous)
        new_state = State(
            breaker_active=False,
            breaker_last_trigger_epoch=0,
            claims_paid=s.claims_paid,
            clearing_price_e8=s.clearing_price_e8,
            clearing_price_epoch=s.clearing_price_epoch,
            clearing_price_seen=s.clearing_price_seen,
            collateral_quote=s.collateral_quote,
            depeg_buffer_bps=s.depeg_buffer_bps,
            entry_price_e8=s.entry_price_e8,
            fee_income=s.fee_income,
            fee_pool_quote=s.fee_pool_quote,
            funding_cap_bps=s.funding_cap_bps,
            funding_last_applied_epoch=s.funding_last_applied_epoch,
            funding_paid_cumulative=s.funding_paid_cumulative,
            funding_rate_bps=s.funding_rate_bps,
            index_price_e8=s.index_price_e8,
            initial_insurance=s.initial_insurance,
            initial_margin_bps=s.initial_margin_bps,
            insurance_balance=s.insurance_balance,
            liquidated_this_step=False,
            liquidation_penalty_bps=s.liquidation_penalty_bps,
            maintenance_margin_bps=s.maintenance_margin_bps,
            max_oracle_move_bps=s.max_oracle_move_bps,
            max_oracle_staleness_epochs=s.max_oracle_staleness_epochs,
            max_position_abs=s.max_position_abs,
            min_notional_for_bounty=s.min_notional_for_bounty,
            now_epoch=s.now_epoch,
            oracle_last_update_epoch=s.oracle_last_update_epoch,
            oracle_seen=s.oracle_seen,
            position_base=s.position_base,
        )
        effects = {
            "collateral_after": new_state.collateral_quote,
            "effective_maint_bps": (
                new_state.depeg_buffer_bps + new_state.maintenance_margin_bps
            ),
            "event": "BreakerCleared",
            "fee_pool_after": new_state.fee_pool_quote,
            "init_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            * new_state.initial_margin_bps
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                * new_state.initial_margin_bps
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "insurance_after": new_state.insurance_balance,
            "liquidated": new_state.liquidated_this_step,
            "maint_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                new_state.depeg_buffer_bps
                                + new_state.maintenance_margin_bps
                            )
                            * (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.depeg_buffer_bps
                                    + new_state.maintenance_margin_bps
                                )
                                * (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "margin_ok": (
                True
                if (0 == new_state.position_base)
                else (
                    new_state.collateral_quote
                    >= (
                        0
                        if 10000 == 0
                        else (
                            (
                                (
                                    (
                                        new_state.depeg_buffer_bps
                                        + new_state.maintenance_margin_bps
                                    )
                                    * (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                                // 10000
                            )
                            + (
                                1
                                if (
                                    (
                                        (
                                            new_state.depeg_buffer_bps
                                            + new_state.maintenance_margin_bps
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                new_state.position_base
                                                                if (
                                                                    new_state.position_base
                                                                    >= 0
                                                                )
                                                                else (
                                                                    0
                                                                    - new_state.position_base
                                                                )
                                                            )
                                                            * new_state.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    % 10000
                                )
                                < 0
                                else 0
                            )
                        )
                    )
                )
            ),
            "notional_quote": (
                0
                if 100000000 == 0
                else (
                    (
                        (
                            (
                                new_state.position_base
                                if (new_state.position_base >= 0)
                                else (0 - new_state.position_base)
                            )
                            * new_state.index_price_e8
                        )
                        // 100000000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.position_base
                                    if (new_state.position_base >= 0)
                                    else (0 - new_state.position_base)
                                )
                                * new_state.index_price_e8
                            )
                            % 100000000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "oracle_fresh": (
                (
                    (new_state.now_epoch - new_state.oracle_last_update_epoch)
                    <= new_state.max_oracle_staleness_epochs
                )
                and new_state.oracle_seen
            ),
        }
        ok, failed = check_invariants(new_state)
        if not ok:
            return StepResult(ok=False, error=f"post-invariant violated: {failed}")
        return StepResult(ok=True, state=new_state, effects=effects)
    elif cmd.tag == "deposit_collateral":
        if "amount" not in cmd.args or not (
            isinstance(cmd.args["amount"], int)
            and not isinstance(cmd.args["amount"], bool)
            and 1 <= cmd.args["amount"] <= 1000000000000
        ):
            return StepResult(ok=False, error="invalid param amount")
        if "auth_ok" not in cmd.args or not (isinstance(cmd.args["auth_ok"], bool)):
            return StepResult(ok=False, error="invalid param auth_ok")
        if not (
            ((cmd.args["amount"] + s.collateral_quote) <= 1000000000000000)
            and (True == cmd.args["auth_ok"])
        ):
            return StepResult(ok=False, error="guard failed for deposit_collateral")
        # Compute updates (simultaneous)
        new_state = State(
            breaker_active=s.breaker_active,
            breaker_last_trigger_epoch=s.breaker_last_trigger_epoch,
            claims_paid=s.claims_paid,
            clearing_price_e8=s.clearing_price_e8,
            clearing_price_epoch=s.clearing_price_epoch,
            clearing_price_seen=s.clearing_price_seen,
            collateral_quote=(cmd.args["amount"] + s.collateral_quote),
            depeg_buffer_bps=s.depeg_buffer_bps,
            entry_price_e8=s.entry_price_e8,
            fee_income=s.fee_income,
            fee_pool_quote=s.fee_pool_quote,
            funding_cap_bps=s.funding_cap_bps,
            funding_last_applied_epoch=s.funding_last_applied_epoch,
            funding_paid_cumulative=s.funding_paid_cumulative,
            funding_rate_bps=s.funding_rate_bps,
            index_price_e8=s.index_price_e8,
            initial_insurance=s.initial_insurance,
            initial_margin_bps=s.initial_margin_bps,
            insurance_balance=s.insurance_balance,
            liquidated_this_step=False,
            liquidation_penalty_bps=s.liquidation_penalty_bps,
            maintenance_margin_bps=s.maintenance_margin_bps,
            max_oracle_move_bps=s.max_oracle_move_bps,
            max_oracle_staleness_epochs=s.max_oracle_staleness_epochs,
            max_position_abs=s.max_position_abs,
            min_notional_for_bounty=s.min_notional_for_bounty,
            now_epoch=s.now_epoch,
            oracle_last_update_epoch=s.oracle_last_update_epoch,
            oracle_seen=s.oracle_seen,
            position_base=s.position_base,
        )
        effects = {
            "collateral_after": new_state.collateral_quote,
            "effective_maint_bps": (
                new_state.depeg_buffer_bps + new_state.maintenance_margin_bps
            ),
            "event": "CollateralDeposited",
            "fee_pool_after": new_state.fee_pool_quote,
            "init_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            * new_state.initial_margin_bps
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                * new_state.initial_margin_bps
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "insurance_after": new_state.insurance_balance,
            "liquidated": new_state.liquidated_this_step,
            "maint_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                new_state.depeg_buffer_bps
                                + new_state.maintenance_margin_bps
                            )
                            * (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.depeg_buffer_bps
                                    + new_state.maintenance_margin_bps
                                )
                                * (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "margin_ok": (
                True
                if (0 == new_state.position_base)
                else (
                    new_state.collateral_quote
                    >= (
                        0
                        if 10000 == 0
                        else (
                            (
                                (
                                    (
                                        new_state.depeg_buffer_bps
                                        + new_state.maintenance_margin_bps
                                    )
                                    * (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                                // 10000
                            )
                            + (
                                1
                                if (
                                    (
                                        (
                                            new_state.depeg_buffer_bps
                                            + new_state.maintenance_margin_bps
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                new_state.position_base
                                                                if (
                                                                    new_state.position_base
                                                                    >= 0
                                                                )
                                                                else (
                                                                    0
                                                                    - new_state.position_base
                                                                )
                                                            )
                                                            * new_state.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    % 10000
                                )
                                < 0
                                else 0
                            )
                        )
                    )
                )
            ),
            "notional_quote": (
                0
                if 100000000 == 0
                else (
                    (
                        (
                            (
                                new_state.position_base
                                if (new_state.position_base >= 0)
                                else (0 - new_state.position_base)
                            )
                            * new_state.index_price_e8
                        )
                        // 100000000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.position_base
                                    if (new_state.position_base >= 0)
                                    else (0 - new_state.position_base)
                                )
                                * new_state.index_price_e8
                            )
                            % 100000000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "oracle_fresh": (
                (
                    (new_state.now_epoch - new_state.oracle_last_update_epoch)
                    <= new_state.max_oracle_staleness_epochs
                )
                and new_state.oracle_seen
            ),
        }
        ok, failed = check_invariants(new_state)
        if not ok:
            return StepResult(ok=False, error=f"post-invariant violated: {failed}")
        return StepResult(ok=True, state=new_state, effects=effects)
    elif cmd.tag == "deposit_insurance":
        if "amount" not in cmd.args or not (
            isinstance(cmd.args["amount"], int)
            and not isinstance(cmd.args["amount"], bool)
            and 1 <= cmd.args["amount"] <= 1000000000000
        ):
            return StepResult(ok=False, error="invalid param amount")
        if not (
            ((cmd.args["amount"] + s.initial_insurance) <= 1000000000000000)
            and ((cmd.args["amount"] + s.insurance_balance) <= 1000000000000000)
        ):
            return StepResult(ok=False, error="guard failed for deposit_insurance")
        # Compute updates (simultaneous)
        new_state = State(
            breaker_active=s.breaker_active,
            breaker_last_trigger_epoch=s.breaker_last_trigger_epoch,
            claims_paid=s.claims_paid,
            clearing_price_e8=s.clearing_price_e8,
            clearing_price_epoch=s.clearing_price_epoch,
            clearing_price_seen=s.clearing_price_seen,
            collateral_quote=s.collateral_quote,
            depeg_buffer_bps=s.depeg_buffer_bps,
            entry_price_e8=s.entry_price_e8,
            fee_income=s.fee_income,
            fee_pool_quote=s.fee_pool_quote,
            funding_cap_bps=s.funding_cap_bps,
            funding_last_applied_epoch=s.funding_last_applied_epoch,
            funding_paid_cumulative=s.funding_paid_cumulative,
            funding_rate_bps=s.funding_rate_bps,
            index_price_e8=s.index_price_e8,
            initial_insurance=(cmd.args["amount"] + s.initial_insurance),
            initial_margin_bps=s.initial_margin_bps,
            insurance_balance=(cmd.args["amount"] + s.insurance_balance),
            liquidated_this_step=False,
            liquidation_penalty_bps=s.liquidation_penalty_bps,
            maintenance_margin_bps=s.maintenance_margin_bps,
            max_oracle_move_bps=s.max_oracle_move_bps,
            max_oracle_staleness_epochs=s.max_oracle_staleness_epochs,
            max_position_abs=s.max_position_abs,
            min_notional_for_bounty=s.min_notional_for_bounty,
            now_epoch=s.now_epoch,
            oracle_last_update_epoch=s.oracle_last_update_epoch,
            oracle_seen=s.oracle_seen,
            position_base=s.position_base,
        )
        effects = {
            "collateral_after": new_state.collateral_quote,
            "effective_maint_bps": (
                new_state.depeg_buffer_bps + new_state.maintenance_margin_bps
            ),
            "event": "InsuranceDeposited",
            "fee_pool_after": new_state.fee_pool_quote,
            "init_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            * new_state.initial_margin_bps
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                * new_state.initial_margin_bps
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "insurance_after": new_state.insurance_balance,
            "liquidated": new_state.liquidated_this_step,
            "maint_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                new_state.depeg_buffer_bps
                                + new_state.maintenance_margin_bps
                            )
                            * (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.depeg_buffer_bps
                                    + new_state.maintenance_margin_bps
                                )
                                * (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "margin_ok": (
                True
                if (0 == new_state.position_base)
                else (
                    new_state.collateral_quote
                    >= (
                        0
                        if 10000 == 0
                        else (
                            (
                                (
                                    (
                                        new_state.depeg_buffer_bps
                                        + new_state.maintenance_margin_bps
                                    )
                                    * (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                                // 10000
                            )
                            + (
                                1
                                if (
                                    (
                                        (
                                            new_state.depeg_buffer_bps
                                            + new_state.maintenance_margin_bps
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                new_state.position_base
                                                                if (
                                                                    new_state.position_base
                                                                    >= 0
                                                                )
                                                                else (
                                                                    0
                                                                    - new_state.position_base
                                                                )
                                                            )
                                                            * new_state.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    % 10000
                                )
                                < 0
                                else 0
                            )
                        )
                    )
                )
            ),
            "notional_quote": (
                0
                if 100000000 == 0
                else (
                    (
                        (
                            (
                                new_state.position_base
                                if (new_state.position_base >= 0)
                                else (0 - new_state.position_base)
                            )
                            * new_state.index_price_e8
                        )
                        // 100000000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.position_base
                                    if (new_state.position_base >= 0)
                                    else (0 - new_state.position_base)
                                )
                                * new_state.index_price_e8
                            )
                            % 100000000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "oracle_fresh": (
                (
                    (new_state.now_epoch - new_state.oracle_last_update_epoch)
                    <= new_state.max_oracle_staleness_epochs
                )
                and new_state.oracle_seen
            ),
        }
        ok, failed = check_invariants(new_state)
        if not ok:
            return StepResult(ok=False, error=f"post-invariant violated: {failed}")
        return StepResult(ok=True, state=new_state, effects=effects)
    elif cmd.tag == "publish_clearing_price":
        if "price_e8" not in cmd.args or not (
            isinstance(cmd.args["price_e8"], int)
            and not isinstance(cmd.args["price_e8"], bool)
            and 1 <= cmd.args["price_e8"] <= 1000000000000
        ):
            return StepResult(ok=False, error="invalid param price_e8")
        if not (s.clearing_price_epoch < s.now_epoch):
            return StepResult(ok=False, error="guard failed for publish_clearing_price")
        # Compute updates (simultaneous)
        new_state = State(
            breaker_active=s.breaker_active,
            breaker_last_trigger_epoch=s.breaker_last_trigger_epoch,
            claims_paid=s.claims_paid,
            clearing_price_e8=cmd.args["price_e8"],
            clearing_price_epoch=s.now_epoch,
            clearing_price_seen=True,
            collateral_quote=s.collateral_quote,
            depeg_buffer_bps=s.depeg_buffer_bps,
            entry_price_e8=s.entry_price_e8,
            fee_income=s.fee_income,
            fee_pool_quote=s.fee_pool_quote,
            funding_cap_bps=s.funding_cap_bps,
            funding_last_applied_epoch=s.funding_last_applied_epoch,
            funding_paid_cumulative=s.funding_paid_cumulative,
            funding_rate_bps=s.funding_rate_bps,
            index_price_e8=s.index_price_e8,
            initial_insurance=s.initial_insurance,
            initial_margin_bps=s.initial_margin_bps,
            insurance_balance=s.insurance_balance,
            liquidated_this_step=False,
            liquidation_penalty_bps=s.liquidation_penalty_bps,
            maintenance_margin_bps=s.maintenance_margin_bps,
            max_oracle_move_bps=s.max_oracle_move_bps,
            max_oracle_staleness_epochs=s.max_oracle_staleness_epochs,
            max_position_abs=s.max_position_abs,
            min_notional_for_bounty=s.min_notional_for_bounty,
            now_epoch=s.now_epoch,
            oracle_last_update_epoch=s.oracle_last_update_epoch,
            oracle_seen=s.oracle_seen,
            position_base=s.position_base,
        )
        effects = {
            "collateral_after": new_state.collateral_quote,
            "effective_maint_bps": (
                new_state.depeg_buffer_bps + new_state.maintenance_margin_bps
            ),
            "event": "ClearingPricePublished",
            "fee_pool_after": new_state.fee_pool_quote,
            "init_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            * new_state.initial_margin_bps
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                * new_state.initial_margin_bps
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "insurance_after": new_state.insurance_balance,
            "liquidated": new_state.liquidated_this_step,
            "maint_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                new_state.depeg_buffer_bps
                                + new_state.maintenance_margin_bps
                            )
                            * (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.depeg_buffer_bps
                                    + new_state.maintenance_margin_bps
                                )
                                * (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "margin_ok": (
                True
                if (0 == new_state.position_base)
                else (
                    new_state.collateral_quote
                    >= (
                        0
                        if 10000 == 0
                        else (
                            (
                                (
                                    (
                                        new_state.depeg_buffer_bps
                                        + new_state.maintenance_margin_bps
                                    )
                                    * (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                                // 10000
                            )
                            + (
                                1
                                if (
                                    (
                                        (
                                            new_state.depeg_buffer_bps
                                            + new_state.maintenance_margin_bps
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                new_state.position_base
                                                                if (
                                                                    new_state.position_base
                                                                    >= 0
                                                                )
                                                                else (
                                                                    0
                                                                    - new_state.position_base
                                                                )
                                                            )
                                                            * new_state.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    % 10000
                                )
                                < 0
                                else 0
                            )
                        )
                    )
                )
            ),
            "notional_quote": (
                0
                if 100000000 == 0
                else (
                    (
                        (
                            (
                                new_state.position_base
                                if (new_state.position_base >= 0)
                                else (0 - new_state.position_base)
                            )
                            * new_state.index_price_e8
                        )
                        // 100000000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.position_base
                                    if (new_state.position_base >= 0)
                                    else (0 - new_state.position_base)
                                )
                                * new_state.index_price_e8
                            )
                            % 100000000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "oracle_fresh": (
                (
                    (new_state.now_epoch - new_state.oracle_last_update_epoch)
                    <= new_state.max_oracle_staleness_epochs
                )
                and new_state.oracle_seen
            ),
        }
        ok, failed = check_invariants(new_state)
        if not ok:
            return StepResult(ok=False, error=f"post-invariant violated: {failed}")
        return StepResult(ok=True, state=new_state, effects=effects)
    elif cmd.tag == "set_position":
        if "new_position_base" not in cmd.args or not (
            isinstance(cmd.args["new_position_base"], int)
            and not isinstance(cmd.args["new_position_base"], bool)
            and -1000000 <= cmd.args["new_position_base"] <= 1000000
        ):
            return StepResult(ok=False, error="invalid param new_position_base")
        if "auth_ok" not in cmd.args or not (isinstance(cmd.args["auth_ok"], bool)):
            return StepResult(ok=False, error="invalid param auth_ok")
        if not (
            (
                (
                    (
                        (0 == cmd.args["new_position_base"])
                        if (0 == s.position_base)
                        else True
                    )
                    and (
                        (
                            cmd.args["new_position_base"]
                            if (cmd.args["new_position_base"] >= 0)
                            else (0 - cmd.args["new_position_base"])
                        )
                        <= (
                            s.position_base
                            if (s.position_base >= 0)
                            else (0 - s.position_base)
                        )
                    )
                    and (
                        (0 == cmd.args["new_position_base"])
                        or (
                            (cmd.args["new_position_base"] <= 0)
                            and (s.position_base <= 0)
                        )
                        or (
                            (cmd.args["new_position_base"] >= 0)
                            and (s.position_base >= 0)
                        )
                    )
                )
                if s.breaker_active
                else (
                    (
                        True
                        if (0 == cmd.args["new_position_base"])
                        else (
                            s.collateral_quote
                            >= (
                                0
                                if 10000 == 0
                                else (
                                    (
                                        (
                                            (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                cmd.args[
                                                                    "new_position_base"
                                                                ]
                                                                if (
                                                                    cmd.args[
                                                                        "new_position_base"
                                                                    ]
                                                                    >= 0
                                                                )
                                                                else (
                                                                    0
                                                                    - cmd.args[
                                                                        "new_position_base"
                                                                    ]
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    cmd.args[
                                                                        "new_position_base"
                                                                    ]
                                                                    if (
                                                                        cmd.args[
                                                                            "new_position_base"
                                                                        ]
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - cmd.args[
                                                                            "new_position_base"
                                                                        ]
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                            * s.initial_margin_bps
                                        )
                                        // 10000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    0
                                                    if 100000000 == 0
                                                    else (
                                                        (
                                                            (
                                                                (
                                                                    cmd.args[
                                                                        "new_position_base"
                                                                    ]
                                                                    if (
                                                                        cmd.args[
                                                                            "new_position_base"
                                                                        ]
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - cmd.args[
                                                                            "new_position_base"
                                                                        ]
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            // 100000000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    (
                                                                        cmd.args[
                                                                            "new_position_base"
                                                                        ]
                                                                        if (
                                                                            cmd.args[
                                                                                "new_position_base"
                                                                            ]
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - cmd.args[
                                                                                "new_position_base"
                                                                            ]
                                                                        )
                                                                    )
                                                                    * s.index_price_e8
                                                                )
                                                                % 100000000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                                * s.initial_margin_bps
                                            )
                                            % 10000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                    )
                    and (
                        (s.now_epoch - s.oracle_last_update_epoch)
                        <= s.max_oracle_staleness_epochs
                    )
                )
            )
            and (
                (
                    cmd.args["new_position_base"]
                    if (cmd.args["new_position_base"] >= 0)
                    else (0 - cmd.args["new_position_base"])
                )
                <= s.max_position_abs
            )
            and (True == cmd.args["auth_ok"])
            and s.oracle_seen
        ):
            return StepResult(ok=False, error="guard failed for set_position")
        # Compute updates (simultaneous)
        new_state = State(
            breaker_active=s.breaker_active,
            breaker_last_trigger_epoch=s.breaker_last_trigger_epoch,
            claims_paid=s.claims_paid,
            clearing_price_e8=s.clearing_price_e8,
            clearing_price_epoch=s.clearing_price_epoch,
            clearing_price_seen=s.clearing_price_seen,
            collateral_quote=s.collateral_quote,
            depeg_buffer_bps=s.depeg_buffer_bps,
            entry_price_e8=(
                0 if (0 == cmd.args["new_position_base"]) else s.index_price_e8
            ),
            fee_income=s.fee_income,
            fee_pool_quote=s.fee_pool_quote,
            funding_cap_bps=s.funding_cap_bps,
            funding_last_applied_epoch=s.funding_last_applied_epoch,
            funding_paid_cumulative=s.funding_paid_cumulative,
            funding_rate_bps=s.funding_rate_bps,
            index_price_e8=s.index_price_e8,
            initial_insurance=s.initial_insurance,
            initial_margin_bps=s.initial_margin_bps,
            insurance_balance=s.insurance_balance,
            liquidated_this_step=False,
            liquidation_penalty_bps=s.liquidation_penalty_bps,
            maintenance_margin_bps=s.maintenance_margin_bps,
            max_oracle_move_bps=s.max_oracle_move_bps,
            max_oracle_staleness_epochs=s.max_oracle_staleness_epochs,
            max_position_abs=s.max_position_abs,
            min_notional_for_bounty=s.min_notional_for_bounty,
            now_epoch=s.now_epoch,
            oracle_last_update_epoch=s.oracle_last_update_epoch,
            oracle_seen=s.oracle_seen,
            position_base=cmd.args["new_position_base"],
        )
        effects = {
            "collateral_after": new_state.collateral_quote,
            "effective_maint_bps": (
                new_state.depeg_buffer_bps + new_state.maintenance_margin_bps
            ),
            "event": "PositionSet",
            "fee_pool_after": new_state.fee_pool_quote,
            "init_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            * new_state.initial_margin_bps
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                * new_state.initial_margin_bps
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "insurance_after": new_state.insurance_balance,
            "liquidated": new_state.liquidated_this_step,
            "maint_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                new_state.depeg_buffer_bps
                                + new_state.maintenance_margin_bps
                            )
                            * (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.depeg_buffer_bps
                                    + new_state.maintenance_margin_bps
                                )
                                * (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "margin_ok": (
                True
                if (0 == new_state.position_base)
                else (
                    new_state.collateral_quote
                    >= (
                        0
                        if 10000 == 0
                        else (
                            (
                                (
                                    (
                                        new_state.depeg_buffer_bps
                                        + new_state.maintenance_margin_bps
                                    )
                                    * (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                                // 10000
                            )
                            + (
                                1
                                if (
                                    (
                                        (
                                            new_state.depeg_buffer_bps
                                            + new_state.maintenance_margin_bps
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                new_state.position_base
                                                                if (
                                                                    new_state.position_base
                                                                    >= 0
                                                                )
                                                                else (
                                                                    0
                                                                    - new_state.position_base
                                                                )
                                                            )
                                                            * new_state.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    % 10000
                                )
                                < 0
                                else 0
                            )
                        )
                    )
                )
            ),
            "notional_quote": (
                0
                if 100000000 == 0
                else (
                    (
                        (
                            (
                                new_state.position_base
                                if (new_state.position_base >= 0)
                                else (0 - new_state.position_base)
                            )
                            * new_state.index_price_e8
                        )
                        // 100000000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.position_base
                                    if (new_state.position_base >= 0)
                                    else (0 - new_state.position_base)
                                )
                                * new_state.index_price_e8
                            )
                            % 100000000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "oracle_fresh": (
                (
                    (new_state.now_epoch - new_state.oracle_last_update_epoch)
                    <= new_state.max_oracle_staleness_epochs
                )
                and new_state.oracle_seen
            ),
        }
        ok, failed = check_invariants(new_state)
        if not ok:
            return StepResult(ok=False, error=f"post-invariant violated: {failed}")
        return StepResult(ok=True, state=new_state, effects=effects)
    elif cmd.tag == "settle_epoch":
        if not (
            (
                (
                    (
                        (
                            min(
                                (
                                    (
                                        (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            * (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                        if (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            + s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                10000
                                                                * (
                                                                    (
                                                                        s.clearing_price_e8
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            > (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        and s.oracle_seen
                                                    )
                                                    else s.clearing_price_e8
                                                )
                                                >= s.index_price_e8
                                            )
                                            == (s.position_base >= 0)
                                        )
                                        else (
                                            0
                                            - (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            * (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                * (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                    )
                                    + s.collateral_quote
                                ),
                                (
                                    0
                                    if 10000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    0
                                                    if 100000000 == 0
                                                    else (
                                                        (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            // 100000000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                    * (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                                % 100000000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                                * s.liquidation_penalty_bps
                                            )
                                            // 10000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        0
                                                        if 100000000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                    * (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                                // 100000000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        (
                                                                            s.position_base
                                                                            if (
                                                                                s.position_base
                                                                                >= 0
                                                                            )
                                                                            else (
                                                                                0
                                                                                - s.position_base
                                                                            )
                                                                        )
                                                                        * (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                    )
                                                                    % 100000000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                    * s.liquidation_penalty_bps
                                                )
                                                % 10000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                ),
                            )
                            if (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                                * (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            + s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                10000
                                                                * (
                                                                    (
                                                                        s.clearing_price_e8
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            > (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        and s.oracle_seen
                                                    )
                                                    else s.clearing_price_e8
                                                )
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                    * (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                >= s.min_notional_for_bounty
                            )
                            else 0
                        )
                        + s.fee_pool_quote
                    )
                    <= 1000000000000000
                )
                if (
                    (
                        (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                )
                                                * (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                if (
                                    (
                                        (
                                            (
                                                (
                                                    (
                                                        0
                                                        if 10000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                // 10000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    % 10000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                    + s.index_price_e8
                                                )
                                                if (
                                                    s.clearing_price_e8
                                                    >= s.index_price_e8
                                                )
                                                else (
                                                    s.index_price_e8
                                                    - (
                                                        0
                                                        if 10000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                // 10000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    % 10000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                )
                                            )
                                            if (
                                                (
                                                    (
                                                        10000
                                                        * (
                                                            (
                                                                s.clearing_price_e8
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    > (
                                                        s.index_price_e8
                                                        * s.max_oracle_move_bps
                                                    )
                                                )
                                                and s.oracle_seen
                                            )
                                            else s.clearing_price_e8
                                        )
                                        >= s.index_price_e8
                                    )
                                    == (s.position_base >= 0)
                                )
                                else (
                                    0
                                    - (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                            )
                            + s.collateral_quote
                        )
                        < (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (
                                        (s.depeg_buffer_bps + s.maintenance_margin_bps)
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                s.depeg_buffer_bps
                                                + s.maintenance_margin_bps
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                    )
                    and (not (0 == s.position_base))
                )
                else True
            )
            and (
                (
                    (
                        (
                            (
                                min(
                                    (
                                        (
                                            (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            * (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                * (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                            if (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    >= s.index_price_e8
                                                )
                                                == (s.position_base >= 0)
                                            )
                                            else (
                                                0
                                                - (
                                                    0
                                                    if 100000000 == 0
                                                    else (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                * (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                            )
                                                            // 100000000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        + s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                                if (
                                                                                    (
                                                                                        (
                                                                                            10000
                                                                                            * (
                                                                                                (
                                                                                                    s.clearing_price_e8
                                                                                                    - s.index_price_e8
                                                                                                )
                                                                                                if (
                                                                                                    s.clearing_price_e8
                                                                                                    >= s.index_price_e8
                                                                                                )
                                                                                                else (
                                                                                                    s.index_price_e8
                                                                                                    - s.clearing_price_e8
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        > (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    and s.oracle_seen
                                                                                )
                                                                                else s.clearing_price_e8
                                                                            )
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        + s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                                if (
                                                                                    (
                                                                                        (
                                                                                            10000
                                                                                            * (
                                                                                                (
                                                                                                    s.clearing_price_e8
                                                                                                    - s.index_price_e8
                                                                                                )
                                                                                                if (
                                                                                                    s.clearing_price_e8
                                                                                                    >= s.index_price_e8
                                                                                                )
                                                                                                else (
                                                                                                    s.index_price_e8
                                                                                                    - s.clearing_price_e8
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        > (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    and s.oracle_seen
                                                                                )
                                                                                else s.clearing_price_e8
                                                                            )
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        + s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                                if (
                                                                                    (
                                                                                        (
                                                                                            10000
                                                                                            * (
                                                                                                (
                                                                                                    s.clearing_price_e8
                                                                                                    - s.index_price_e8
                                                                                                )
                                                                                                if (
                                                                                                    s.clearing_price_e8
                                                                                                    >= s.index_price_e8
                                                                                                )
                                                                                                else (
                                                                                                    s.index_price_e8
                                                                                                    - s.clearing_price_e8
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        > (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    and s.oracle_seen
                                                                                )
                                                                                else s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    * (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                )
                                                                % 100000000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                            )
                                        )
                                        + s.collateral_quote
                                    ),
                                    (
                                        0
                                        if 10000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        0
                                                        if 100000000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                    * (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                                // 100000000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        (
                                                                            s.position_base
                                                                            if (
                                                                                s.position_base
                                                                                >= 0
                                                                            )
                                                                            else (
                                                                                0
                                                                                - s.position_base
                                                                            )
                                                                        )
                                                                        * (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                    )
                                                                    % 100000000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                    * s.liquidation_penalty_bps
                                                )
                                                // 10000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            0
                                                            if 100000000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        (
                                                                            s.position_base
                                                                            if (
                                                                                s.position_base
                                                                                >= 0
                                                                            )
                                                                            else (
                                                                                0
                                                                                - s.position_base
                                                                            )
                                                                        )
                                                                        * (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                    )
                                                                    // 100000000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            (
                                                                                s.position_base
                                                                                if (
                                                                                    s.position_base
                                                                                    >= 0
                                                                                )
                                                                                else (
                                                                                    0
                                                                                    - s.position_base
                                                                                )
                                                                            )
                                                                            * (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        + s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                                if (
                                                                                    (
                                                                                        (
                                                                                            10000
                                                                                            * (
                                                                                                (
                                                                                                    s.clearing_price_e8
                                                                                                    - s.index_price_e8
                                                                                                )
                                                                                                if (
                                                                                                    s.clearing_price_e8
                                                                                                    >= s.index_price_e8
                                                                                                )
                                                                                                else (
                                                                                                    s.index_price_e8
                                                                                                    - s.clearing_price_e8
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        > (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    and s.oracle_seen
                                                                                )
                                                                                else s.clearing_price_e8
                                                                            )
                                                                        )
                                                                        % 100000000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                        * s.liquidation_penalty_bps
                                                    )
                                                    % 10000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    ),
                                )
                                if (
                                    (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                    * (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                    >= s.min_notional_for_bounty
                                )
                                else 0
                            )
                            + s.fee_income
                        )
                        <= 1000000000000000
                    )
                    and (
                        (
                            (
                                (
                                    (
                                        min(
                                            (
                                                (
                                                    (
                                                        0
                                                        if 100000000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        + s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                                if (
                                                                                    (
                                                                                        (
                                                                                            10000
                                                                                            * (
                                                                                                (
                                                                                                    s.clearing_price_e8
                                                                                                    - s.index_price_e8
                                                                                                )
                                                                                                if (
                                                                                                    s.clearing_price_e8
                                                                                                    >= s.index_price_e8
                                                                                                )
                                                                                                else (
                                                                                                    s.index_price_e8
                                                                                                    - s.clearing_price_e8
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        > (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    and s.oracle_seen
                                                                                )
                                                                                else s.clearing_price_e8
                                                                            )
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        + s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                                if (
                                                                                    (
                                                                                        (
                                                                                            10000
                                                                                            * (
                                                                                                (
                                                                                                    s.clearing_price_e8
                                                                                                    - s.index_price_e8
                                                                                                )
                                                                                                if (
                                                                                                    s.clearing_price_e8
                                                                                                    >= s.index_price_e8
                                                                                                )
                                                                                                else (
                                                                                                    s.index_price_e8
                                                                                                    - s.clearing_price_e8
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        > (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    and s.oracle_seen
                                                                                )
                                                                                else s.clearing_price_e8
                                                                            )
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        + s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                                if (
                                                                                    (
                                                                                        (
                                                                                            10000
                                                                                            * (
                                                                                                (
                                                                                                    s.clearing_price_e8
                                                                                                    - s.index_price_e8
                                                                                                )
                                                                                                if (
                                                                                                    s.clearing_price_e8
                                                                                                    >= s.index_price_e8
                                                                                                )
                                                                                                else (
                                                                                                    s.index_price_e8
                                                                                                    - s.clearing_price_e8
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        > (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    and s.oracle_seen
                                                                                )
                                                                                else s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    * (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                )
                                                                // 100000000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            + s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    if (
                                                                                        (
                                                                                            (
                                                                                                10000
                                                                                                * (
                                                                                                    (
                                                                                                        s.clearing_price_e8
                                                                                                        - s.index_price_e8
                                                                                                    )
                                                                                                    if (
                                                                                                        s.clearing_price_e8
                                                                                                        >= s.index_price_e8
                                                                                                    )
                                                                                                    else (
                                                                                                        s.index_price_e8
                                                                                                        - s.clearing_price_e8
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            > (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        and s.oracle_seen
                                                                                    )
                                                                                    else s.clearing_price_e8
                                                                                )
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            + s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    if (
                                                                                        (
                                                                                            (
                                                                                                10000
                                                                                                * (
                                                                                                    (
                                                                                                        s.clearing_price_e8
                                                                                                        - s.index_price_e8
                                                                                                    )
                                                                                                    if (
                                                                                                        s.clearing_price_e8
                                                                                                        >= s.index_price_e8
                                                                                                    )
                                                                                                    else (
                                                                                                        s.index_price_e8
                                                                                                        - s.clearing_price_e8
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            > (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        and s.oracle_seen
                                                                                    )
                                                                                    else s.clearing_price_e8
                                                                                )
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    (
                                                                                        (
                                                                                            (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            + s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    if (
                                                                                        (
                                                                                            (
                                                                                                10000
                                                                                                * (
                                                                                                    (
                                                                                                        s.clearing_price_e8
                                                                                                        - s.index_price_e8
                                                                                                    )
                                                                                                    if (
                                                                                                        s.clearing_price_e8
                                                                                                        >= s.index_price_e8
                                                                                                    )
                                                                                                    else (
                                                                                                        s.index_price_e8
                                                                                                        - s.clearing_price_e8
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            > (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        and s.oracle_seen
                                                                                    )
                                                                                    else s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        * (
                                                                            s.position_base
                                                                            if (
                                                                                s.position_base
                                                                                >= 0
                                                                            )
                                                                            else (
                                                                                0
                                                                                - s.position_base
                                                                            )
                                                                        )
                                                                    )
                                                                    % 100000000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        == (s.position_base >= 0)
                                                    )
                                                    else (
                                                        0
                                                        - (
                                                            0
                                                            if 100000000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            + s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    if (
                                                                                        (
                                                                                            (
                                                                                                10000
                                                                                                * (
                                                                                                    (
                                                                                                        s.clearing_price_e8
                                                                                                        - s.index_price_e8
                                                                                                    )
                                                                                                    if (
                                                                                                        s.clearing_price_e8
                                                                                                        >= s.index_price_e8
                                                                                                    )
                                                                                                    else (
                                                                                                        s.index_price_e8
                                                                                                        - s.clearing_price_e8
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            > (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        and s.oracle_seen
                                                                                    )
                                                                                    else s.clearing_price_e8
                                                                                )
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            + s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    if (
                                                                                        (
                                                                                            (
                                                                                                10000
                                                                                                * (
                                                                                                    (
                                                                                                        s.clearing_price_e8
                                                                                                        - s.index_price_e8
                                                                                                    )
                                                                                                    if (
                                                                                                        s.clearing_price_e8
                                                                                                        >= s.index_price_e8
                                                                                                    )
                                                                                                    else (
                                                                                                        s.index_price_e8
                                                                                                        - s.clearing_price_e8
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            > (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        and s.oracle_seen
                                                                                    )
                                                                                    else s.clearing_price_e8
                                                                                )
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    (
                                                                                        (
                                                                                            (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            + s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    if (
                                                                                        (
                                                                                            (
                                                                                                10000
                                                                                                * (
                                                                                                    (
                                                                                                        s.clearing_price_e8
                                                                                                        - s.index_price_e8
                                                                                                    )
                                                                                                    if (
                                                                                                        s.clearing_price_e8
                                                                                                        >= s.index_price_e8
                                                                                                    )
                                                                                                    else (
                                                                                                        s.index_price_e8
                                                                                                        - s.clearing_price_e8
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            > (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        and s.oracle_seen
                                                                                    )
                                                                                    else s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        * (
                                                                            s.position_base
                                                                            if (
                                                                                s.position_base
                                                                                >= 0
                                                                            )
                                                                            else (
                                                                                0
                                                                                - s.position_base
                                                                            )
                                                                        )
                                                                    )
                                                                    // 100000000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            (
                                                                                                (
                                                                                                    0
                                                                                                    if 10000
                                                                                                    == 0
                                                                                                    else (
                                                                                                        (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            // 10000
                                                                                                        )
                                                                                                        + (
                                                                                                            1
                                                                                                            if (
                                                                                                                (
                                                                                                                    9999
                                                                                                                    + (
                                                                                                                        s.index_price_e8
                                                                                                                        * s.max_oracle_move_bps
                                                                                                                    )
                                                                                                                )
                                                                                                                % 10000
                                                                                                            )
                                                                                                            < 0
                                                                                                            else 0
                                                                                                        )
                                                                                                    )
                                                                                                )
                                                                                                + s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - (
                                                                                                    0
                                                                                                    if 10000
                                                                                                    == 0
                                                                                                    else (
                                                                                                        (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            // 10000
                                                                                                        )
                                                                                                        + (
                                                                                                            1
                                                                                                            if (
                                                                                                                (
                                                                                                                    9999
                                                                                                                    + (
                                                                                                                        s.index_price_e8
                                                                                                                        * s.max_oracle_move_bps
                                                                                                                    )
                                                                                                                )
                                                                                                                % 10000
                                                                                                            )
                                                                                                            < 0
                                                                                                            else 0
                                                                                                        )
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        if (
                                                                                            (
                                                                                                (
                                                                                                    10000
                                                                                                    * (
                                                                                                        (
                                                                                                            s.clearing_price_e8
                                                                                                            - s.index_price_e8
                                                                                                        )
                                                                                                        if (
                                                                                                            s.clearing_price_e8
                                                                                                            >= s.index_price_e8
                                                                                                        )
                                                                                                        else (
                                                                                                            s.index_price_e8
                                                                                                            - s.clearing_price_e8
                                                                                                        )
                                                                                                    )
                                                                                                )
                                                                                                > (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            and s.oracle_seen
                                                                                        )
                                                                                        else s.clearing_price_e8
                                                                                    )
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    (
                                                                                        (
                                                                                            (
                                                                                                (
                                                                                                    0
                                                                                                    if 10000
                                                                                                    == 0
                                                                                                    else (
                                                                                                        (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            // 10000
                                                                                                        )
                                                                                                        + (
                                                                                                            1
                                                                                                            if (
                                                                                                                (
                                                                                                                    9999
                                                                                                                    + (
                                                                                                                        s.index_price_e8
                                                                                                                        * s.max_oracle_move_bps
                                                                                                                    )
                                                                                                                )
                                                                                                                % 10000
                                                                                                            )
                                                                                                            < 0
                                                                                                            else 0
                                                                                                        )
                                                                                                    )
                                                                                                )
                                                                                                + s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - (
                                                                                                    0
                                                                                                    if 10000
                                                                                                    == 0
                                                                                                    else (
                                                                                                        (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            // 10000
                                                                                                        )
                                                                                                        + (
                                                                                                            1
                                                                                                            if (
                                                                                                                (
                                                                                                                    9999
                                                                                                                    + (
                                                                                                                        s.index_price_e8
                                                                                                                        * s.max_oracle_move_bps
                                                                                                                    )
                                                                                                                )
                                                                                                                % 10000
                                                                                                            )
                                                                                                            < 0
                                                                                                            else 0
                                                                                                        )
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        if (
                                                                                            (
                                                                                                (
                                                                                                    10000
                                                                                                    * (
                                                                                                        (
                                                                                                            s.clearing_price_e8
                                                                                                            - s.index_price_e8
                                                                                                        )
                                                                                                        if (
                                                                                                            s.clearing_price_e8
                                                                                                            >= s.index_price_e8
                                                                                                        )
                                                                                                        else (
                                                                                                            s.index_price_e8
                                                                                                            - s.clearing_price_e8
                                                                                                        )
                                                                                                    )
                                                                                                )
                                                                                                > (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            and s.oracle_seen
                                                                                        )
                                                                                        else s.clearing_price_e8
                                                                                    )
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        (
                                                                                            (
                                                                                                (
                                                                                                    0
                                                                                                    if 10000
                                                                                                    == 0
                                                                                                    else (
                                                                                                        (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            // 10000
                                                                                                        )
                                                                                                        + (
                                                                                                            1
                                                                                                            if (
                                                                                                                (
                                                                                                                    9999
                                                                                                                    + (
                                                                                                                        s.index_price_e8
                                                                                                                        * s.max_oracle_move_bps
                                                                                                                    )
                                                                                                                )
                                                                                                                % 10000
                                                                                                            )
                                                                                                            < 0
                                                                                                            else 0
                                                                                                        )
                                                                                                    )
                                                                                                )
                                                                                                + s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - (
                                                                                                    0
                                                                                                    if 10000
                                                                                                    == 0
                                                                                                    else (
                                                                                                        (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            // 10000
                                                                                                        )
                                                                                                        + (
                                                                                                            1
                                                                                                            if (
                                                                                                                (
                                                                                                                    9999
                                                                                                                    + (
                                                                                                                        s.index_price_e8
                                                                                                                        * s.max_oracle_move_bps
                                                                                                                    )
                                                                                                                )
                                                                                                                % 10000
                                                                                                            )
                                                                                                            < 0
                                                                                                            else 0
                                                                                                        )
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        if (
                                                                                            (
                                                                                                (
                                                                                                    10000
                                                                                                    * (
                                                                                                        (
                                                                                                            s.clearing_price_e8
                                                                                                            - s.index_price_e8
                                                                                                        )
                                                                                                        if (
                                                                                                            s.clearing_price_e8
                                                                                                            >= s.index_price_e8
                                                                                                        )
                                                                                                        else (
                                                                                                            s.index_price_e8
                                                                                                            - s.clearing_price_e8
                                                                                                        )
                                                                                                    )
                                                                                                )
                                                                                                > (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            and s.oracle_seen
                                                                                        )
                                                                                        else s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            * (
                                                                                s.position_base
                                                                                if (
                                                                                    s.position_base
                                                                                    >= 0
                                                                                )
                                                                                else (
                                                                                    0
                                                                                    - s.position_base
                                                                                )
                                                                            )
                                                                        )
                                                                        % 100000000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                    )
                                                )
                                                + s.collateral_quote
                                            ),
                                            (
                                                0
                                                if 10000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 100000000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            (
                                                                                s.position_base
                                                                                if (
                                                                                    s.position_base
                                                                                    >= 0
                                                                                )
                                                                                else (
                                                                                    0
                                                                                    - s.position_base
                                                                                )
                                                                            )
                                                                            * (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        + s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                                if (
                                                                                    (
                                                                                        (
                                                                                            10000
                                                                                            * (
                                                                                                (
                                                                                                    s.clearing_price_e8
                                                                                                    - s.index_price_e8
                                                                                                )
                                                                                                if (
                                                                                                    s.clearing_price_e8
                                                                                                    >= s.index_price_e8
                                                                                                )
                                                                                                else (
                                                                                                    s.index_price_e8
                                                                                                    - s.clearing_price_e8
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        > (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    and s.oracle_seen
                                                                                )
                                                                                else s.clearing_price_e8
                                                                            )
                                                                        )
                                                                        // 100000000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                (
                                                                                    s.position_base
                                                                                    if (
                                                                                        s.position_base
                                                                                        >= 0
                                                                                    )
                                                                                    else (
                                                                                        0
                                                                                        - s.position_base
                                                                                    )
                                                                                )
                                                                                * (
                                                                                    (
                                                                                        (
                                                                                            (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            + s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    if (
                                                                                        (
                                                                                            (
                                                                                                10000
                                                                                                * (
                                                                                                    (
                                                                                                        s.clearing_price_e8
                                                                                                        - s.index_price_e8
                                                                                                    )
                                                                                                    if (
                                                                                                        s.clearing_price_e8
                                                                                                        >= s.index_price_e8
                                                                                                    )
                                                                                                    else (
                                                                                                        s.index_price_e8
                                                                                                        - s.clearing_price_e8
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            > (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        and s.oracle_seen
                                                                                    )
                                                                                    else s.clearing_price_e8
                                                                                )
                                                                            )
                                                                            % 100000000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            * s.liquidation_penalty_bps
                                                        )
                                                        // 10000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    0
                                                                    if 100000000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                (
                                                                                    s.position_base
                                                                                    if (
                                                                                        s.position_base
                                                                                        >= 0
                                                                                    )
                                                                                    else (
                                                                                        0
                                                                                        - s.position_base
                                                                                    )
                                                                                )
                                                                                * (
                                                                                    (
                                                                                        (
                                                                                            (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            + s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - (
                                                                                                0
                                                                                                if 10000
                                                                                                == 0
                                                                                                else (
                                                                                                    (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        // 10000
                                                                                                    )
                                                                                                    + (
                                                                                                        1
                                                                                                        if (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            % 10000
                                                                                                        )
                                                                                                        < 0
                                                                                                        else 0
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    if (
                                                                                        (
                                                                                            (
                                                                                                10000
                                                                                                * (
                                                                                                    (
                                                                                                        s.clearing_price_e8
                                                                                                        - s.index_price_e8
                                                                                                    )
                                                                                                    if (
                                                                                                        s.clearing_price_e8
                                                                                                        >= s.index_price_e8
                                                                                                    )
                                                                                                    else (
                                                                                                        s.index_price_e8
                                                                                                        - s.clearing_price_e8
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                            > (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        and s.oracle_seen
                                                                                    )
                                                                                    else s.clearing_price_e8
                                                                                )
                                                                            )
                                                                            // 100000000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        s.position_base
                                                                                        if (
                                                                                            s.position_base
                                                                                            >= 0
                                                                                        )
                                                                                        else (
                                                                                            0
                                                                                            - s.position_base
                                                                                        )
                                                                                    )
                                                                                    * (
                                                                                        (
                                                                                            (
                                                                                                (
                                                                                                    0
                                                                                                    if 10000
                                                                                                    == 0
                                                                                                    else (
                                                                                                        (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            // 10000
                                                                                                        )
                                                                                                        + (
                                                                                                            1
                                                                                                            if (
                                                                                                                (
                                                                                                                    9999
                                                                                                                    + (
                                                                                                                        s.index_price_e8
                                                                                                                        * s.max_oracle_move_bps
                                                                                                                    )
                                                                                                                )
                                                                                                                % 10000
                                                                                                            )
                                                                                                            < 0
                                                                                                            else 0
                                                                                                        )
                                                                                                    )
                                                                                                )
                                                                                                + s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - (
                                                                                                    0
                                                                                                    if 10000
                                                                                                    == 0
                                                                                                    else (
                                                                                                        (
                                                                                                            (
                                                                                                                9999
                                                                                                                + (
                                                                                                                    s.index_price_e8
                                                                                                                    * s.max_oracle_move_bps
                                                                                                                )
                                                                                                            )
                                                                                                            // 10000
                                                                                                        )
                                                                                                        + (
                                                                                                            1
                                                                                                            if (
                                                                                                                (
                                                                                                                    9999
                                                                                                                    + (
                                                                                                                        s.index_price_e8
                                                                                                                        * s.max_oracle_move_bps
                                                                                                                    )
                                                                                                                )
                                                                                                                % 10000
                                                                                                            )
                                                                                                            < 0
                                                                                                            else 0
                                                                                                        )
                                                                                                    )
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        if (
                                                                                            (
                                                                                                (
                                                                                                    10000
                                                                                                    * (
                                                                                                        (
                                                                                                            s.clearing_price_e8
                                                                                                            - s.index_price_e8
                                                                                                        )
                                                                                                        if (
                                                                                                            s.clearing_price_e8
                                                                                                            >= s.index_price_e8
                                                                                                        )
                                                                                                        else (
                                                                                                            s.index_price_e8
                                                                                                            - s.clearing_price_e8
                                                                                                        )
                                                                                                    )
                                                                                                )
                                                                                                > (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            and s.oracle_seen
                                                                                        )
                                                                                        else s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                                % 100000000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                * s.liquidation_penalty_bps
                                                            )
                                                            % 10000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            ),
                                        )
                                        if (
                                            (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                            >= s.min_notional_for_bounty
                                        )
                                        else 0
                                    )
                                    + s.fee_income
                                )
                                + s.initial_insurance
                            )
                            - s.claims_paid
                        )
                        <= 1000000000000000
                    )
                )
                if (
                    (
                        (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                )
                                                * (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                if (
                                    (
                                        (
                                            (
                                                (
                                                    (
                                                        0
                                                        if 10000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                // 10000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    % 10000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                    + s.index_price_e8
                                                )
                                                if (
                                                    s.clearing_price_e8
                                                    >= s.index_price_e8
                                                )
                                                else (
                                                    s.index_price_e8
                                                    - (
                                                        0
                                                        if 10000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                // 10000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    % 10000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                )
                                            )
                                            if (
                                                (
                                                    (
                                                        10000
                                                        * (
                                                            (
                                                                s.clearing_price_e8
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    > (
                                                        s.index_price_e8
                                                        * s.max_oracle_move_bps
                                                    )
                                                )
                                                and s.oracle_seen
                                            )
                                            else s.clearing_price_e8
                                        )
                                        >= s.index_price_e8
                                    )
                                    == (s.position_base >= 0)
                                )
                                else (
                                    0
                                    - (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                            )
                            + s.collateral_quote
                        )
                        < (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (
                                        (s.depeg_buffer_bps + s.maintenance_margin_bps)
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                s.depeg_buffer_bps
                                                + s.maintenance_margin_bps
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                    )
                    and (not (0 == s.position_base))
                )
                else True
            )
            and (s.oracle_last_update_epoch < s.now_epoch)
            and (
                (
                    (
                        (
                            0
                            if 100000000 == 0
                            else (
                                (
                                    (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            + s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                10000
                                                                * (
                                                                    (
                                                                        s.clearing_price_e8
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            > (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        and s.oracle_seen
                                                    )
                                                    else s.clearing_price_e8
                                                )
                                                - s.index_price_e8
                                            )
                                            if (
                                                (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            + s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                10000
                                                                * (
                                                                    (
                                                                        s.clearing_price_e8
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            > (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        and s.oracle_seen
                                                    )
                                                    else s.clearing_price_e8
                                                )
                                                >= s.index_price_e8
                                            )
                                            else (
                                                s.index_price_e8
                                                - (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            + s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                10000
                                                                * (
                                                                    (
                                                                        s.clearing_price_e8
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            > (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        and s.oracle_seen
                                                    )
                                                    else s.clearing_price_e8
                                                )
                                            )
                                        )
                                        * (
                                            s.position_base
                                            if (s.position_base >= 0)
                                            else (0 - s.position_base)
                                        )
                                    )
                                    // 100000000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    - s.index_price_e8
                                                )
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    >= s.index_price_e8
                                                )
                                                else (
                                                    s.index_price_e8
                                                    - (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                )
                                            )
                                            * (
                                                s.position_base
                                                if (s.position_base >= 0)
                                                else (0 - s.position_base)
                                            )
                                        )
                                        % 100000000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                        if (
                            (
                                (
                                    (
                                        (
                                            (
                                                0
                                                if 10000 == 0
                                                else (
                                                    (
                                                        (
                                                            9999
                                                            + (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        // 10000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                9999
                                                                + (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            % 10000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                            + s.index_price_e8
                                        )
                                        if (s.clearing_price_e8 >= s.index_price_e8)
                                        else (
                                            s.index_price_e8
                                            - (
                                                0
                                                if 10000 == 0
                                                else (
                                                    (
                                                        (
                                                            9999
                                                            + (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        // 10000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                9999
                                                                + (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            % 10000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                    )
                                    if (
                                        (
                                            (
                                                10000
                                                * (
                                                    (
                                                        s.clearing_price_e8
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        s.clearing_price_e8
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - s.clearing_price_e8
                                                    )
                                                )
                                            )
                                            > (s.index_price_e8 * s.max_oracle_move_bps)
                                        )
                                        and s.oracle_seen
                                    )
                                    else s.clearing_price_e8
                                )
                                >= s.index_price_e8
                            )
                            == (s.position_base >= 0)
                        )
                        else (
                            0
                            - (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    - s.index_price_e8
                                                )
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    >= s.index_price_e8
                                                )
                                                else (
                                                    s.index_price_e8
                                                    - (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                )
                                            )
                                            * (
                                                s.position_base
                                                if (s.position_base >= 0)
                                                else (0 - s.position_base)
                                            )
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                )
                                                * (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                    )
                    + s.collateral_quote
                )
                <= 1000000000000000
            )
            and (s.clearing_price_epoch == s.now_epoch)
            and (
                (
                    (
                        (
                            0
                            if 100000000 == 0
                            else (
                                (
                                    (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            + s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                10000
                                                                * (
                                                                    (
                                                                        s.clearing_price_e8
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            > (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        and s.oracle_seen
                                                    )
                                                    else s.clearing_price_e8
                                                )
                                                - s.index_price_e8
                                            )
                                            if (
                                                (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            + s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                10000
                                                                * (
                                                                    (
                                                                        s.clearing_price_e8
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            > (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        and s.oracle_seen
                                                    )
                                                    else s.clearing_price_e8
                                                )
                                                >= s.index_price_e8
                                            )
                                            else (
                                                s.index_price_e8
                                                - (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            + s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                10000
                                                                * (
                                                                    (
                                                                        s.clearing_price_e8
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            > (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        and s.oracle_seen
                                                    )
                                                    else s.clearing_price_e8
                                                )
                                            )
                                        )
                                        * (
                                            s.position_base
                                            if (s.position_base >= 0)
                                            else (0 - s.position_base)
                                        )
                                    )
                                    // 100000000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    - s.index_price_e8
                                                )
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    >= s.index_price_e8
                                                )
                                                else (
                                                    s.index_price_e8
                                                    - (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                )
                                            )
                                            * (
                                                s.position_base
                                                if (s.position_base >= 0)
                                                else (0 - s.position_base)
                                            )
                                        )
                                        % 100000000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                        if (
                            (
                                (
                                    (
                                        (
                                            (
                                                0
                                                if 10000 == 0
                                                else (
                                                    (
                                                        (
                                                            9999
                                                            + (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        // 10000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                9999
                                                                + (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            % 10000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                            + s.index_price_e8
                                        )
                                        if (s.clearing_price_e8 >= s.index_price_e8)
                                        else (
                                            s.index_price_e8
                                            - (
                                                0
                                                if 10000 == 0
                                                else (
                                                    (
                                                        (
                                                            9999
                                                            + (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        // 10000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                9999
                                                                + (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            % 10000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                    )
                                    if (
                                        (
                                            (
                                                10000
                                                * (
                                                    (
                                                        s.clearing_price_e8
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        s.clearing_price_e8
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - s.clearing_price_e8
                                                    )
                                                )
                                            )
                                            > (s.index_price_e8 * s.max_oracle_move_bps)
                                        )
                                        and s.oracle_seen
                                    )
                                    else s.clearing_price_e8
                                )
                                >= s.index_price_e8
                            )
                            == (s.position_base >= 0)
                        )
                        else (
                            0
                            - (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    - s.index_price_e8
                                                )
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    >= s.index_price_e8
                                                )
                                                else (
                                                    s.index_price_e8
                                                    - (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                )
                                            )
                                            * (
                                                s.position_base
                                                if (s.position_base >= 0)
                                                else (0 - s.position_base)
                                            )
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                )
                                                * (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                    )
                    + s.collateral_quote
                )
                >= 0
            )
            and s.clearing_price_seen
        ):
            return StepResult(ok=False, error="guard failed for settle_epoch")
        # Compute updates (simultaneous)
        new_state = State(
            breaker_active=(
                (
                    (
                        (
                            10000
                            * (
                                (s.clearing_price_e8 - s.index_price_e8)
                                if (s.clearing_price_e8 >= s.index_price_e8)
                                else (s.index_price_e8 - s.clearing_price_e8)
                            )
                        )
                        > (s.index_price_e8 * s.max_oracle_move_bps)
                    )
                    and s.oracle_seen
                )
                or s.breaker_active
            ),
            breaker_last_trigger_epoch=(
                s.now_epoch
                if (
                    (
                        (
                            10000
                            * (
                                (s.clearing_price_e8 - s.index_price_e8)
                                if (s.clearing_price_e8 >= s.index_price_e8)
                                else (s.index_price_e8 - s.clearing_price_e8)
                            )
                        )
                        > (s.index_price_e8 * s.max_oracle_move_bps)
                    )
                    and s.oracle_seen
                )
                else s.breaker_last_trigger_epoch
            ),
            claims_paid=s.claims_paid,
            clearing_price_e8=s.clearing_price_e8,
            clearing_price_epoch=s.clearing_price_epoch,
            clearing_price_seen=s.clearing_price_seen,
            collateral_quote=(
                (
                    (
                        (
                            (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    - s.index_price_e8
                                                )
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    >= s.index_price_e8
                                                )
                                                else (
                                                    s.index_price_e8
                                                    - (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                )
                                            )
                                            * (
                                                s.position_base
                                                if (s.position_base >= 0)
                                                else (0 - s.position_base)
                                            )
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                )
                                                * (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            if (
                                (
                                    (
                                        (
                                            (
                                                (
                                                    0
                                                    if 10000 == 0
                                                    else (
                                                        (
                                                            (
                                                                9999
                                                                + (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            // 10000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                % 10000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                                + s.index_price_e8
                                            )
                                            if (s.clearing_price_e8 >= s.index_price_e8)
                                            else (
                                                s.index_price_e8
                                                - (
                                                    0
                                                    if 10000 == 0
                                                    else (
                                                        (
                                                            (
                                                                9999
                                                                + (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            // 10000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                % 10000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                            )
                                        )
                                        if (
                                            (
                                                (
                                                    10000
                                                    * (
                                                        (
                                                            s.clearing_price_e8
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - s.clearing_price_e8
                                                        )
                                                    )
                                                )
                                                > (
                                                    s.index_price_e8
                                                    * s.max_oracle_move_bps
                                                )
                                            )
                                            and s.oracle_seen
                                        )
                                        else s.clearing_price_e8
                                    )
                                    >= s.index_price_e8
                                )
                                == (s.position_base >= 0)
                            )
                            else (
                                0
                                - (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                )
                                                * (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                            )
                        )
                        + s.collateral_quote
                    )
                    - (
                        min(
                            (
                                (
                                    (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                    if (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            0
                                                            if 10000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    // 10000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        % 10000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                        + s.index_price_e8
                                                    )
                                                    if (
                                                        s.clearing_price_e8
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            0
                                                            if 10000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    // 10000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        % 10000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                    )
                                                )
                                                if (
                                                    (
                                                        (
                                                            10000
                                                            * (
                                                                (
                                                                    s.clearing_price_e8
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        > (
                                                            s.index_price_e8
                                                            * s.max_oracle_move_bps
                                                        )
                                                    )
                                                    and s.oracle_seen
                                                )
                                                else s.clearing_price_e8
                                            )
                                            >= s.index_price_e8
                                        )
                                        == (s.position_base >= 0)
                                    )
                                    else (
                                        0
                                        - (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            * (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                )
                                + s.collateral_quote
                            ),
                            (
                                0
                                if 10000 == 0
                                else (
                                    (
                                        (
                                            (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                            * s.liquidation_penalty_bps
                                        )
                                        // 10000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    0
                                                    if 100000000 == 0
                                                    else (
                                                        (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            // 100000000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                    * (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                                % 100000000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                                * s.liquidation_penalty_bps
                                            )
                                            % 10000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            ),
                        )
                        if (
                            (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                s.position_base
                                                if (s.position_base >= 0)
                                                else (0 - s.position_base)
                                            )
                                            * (
                                                (
                                                    (
                                                        (
                                                            0
                                                            if 10000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    // 10000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        % 10000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                        + s.index_price_e8
                                                    )
                                                    if (
                                                        s.clearing_price_e8
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            0
                                                            if 10000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    // 10000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        % 10000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                    )
                                                )
                                                if (
                                                    (
                                                        (
                                                            10000
                                                            * (
                                                                (
                                                                    s.clearing_price_e8
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        > (
                                                            s.index_price_e8
                                                            * s.max_oracle_move_bps
                                                        )
                                                    )
                                                    and s.oracle_seen
                                                )
                                                else s.clearing_price_e8
                                            )
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                                * (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            + s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                10000
                                                                * (
                                                                    (
                                                                        s.clearing_price_e8
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            > (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        and s.oracle_seen
                                                    )
                                                    else s.clearing_price_e8
                                                )
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            >= s.min_notional_for_bounty
                        )
                        else 0
                    )
                )
                if (
                    (
                        (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                )
                                                * (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                if (
                                    (
                                        (
                                            (
                                                (
                                                    (
                                                        0
                                                        if 10000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                // 10000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    % 10000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                    + s.index_price_e8
                                                )
                                                if (
                                                    s.clearing_price_e8
                                                    >= s.index_price_e8
                                                )
                                                else (
                                                    s.index_price_e8
                                                    - (
                                                        0
                                                        if 10000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                // 10000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    % 10000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                )
                                            )
                                            if (
                                                (
                                                    (
                                                        10000
                                                        * (
                                                            (
                                                                s.clearing_price_e8
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    > (
                                                        s.index_price_e8
                                                        * s.max_oracle_move_bps
                                                    )
                                                )
                                                and s.oracle_seen
                                            )
                                            else s.clearing_price_e8
                                        )
                                        >= s.index_price_e8
                                    )
                                    == (s.position_base >= 0)
                                )
                                else (
                                    0
                                    - (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                            )
                            + s.collateral_quote
                        )
                        < (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (
                                        (s.depeg_buffer_bps + s.maintenance_margin_bps)
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                s.depeg_buffer_bps
                                                + s.maintenance_margin_bps
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                    )
                    and (not (0 == s.position_base))
                )
                else (
                    (
                        (
                            0
                            if 100000000 == 0
                            else (
                                (
                                    (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            + s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                10000
                                                                * (
                                                                    (
                                                                        s.clearing_price_e8
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            > (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        and s.oracle_seen
                                                    )
                                                    else s.clearing_price_e8
                                                )
                                                - s.index_price_e8
                                            )
                                            if (
                                                (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            + s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                10000
                                                                * (
                                                                    (
                                                                        s.clearing_price_e8
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            > (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        and s.oracle_seen
                                                    )
                                                    else s.clearing_price_e8
                                                )
                                                >= s.index_price_e8
                                            )
                                            else (
                                                s.index_price_e8
                                                - (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            + s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                10000
                                                                * (
                                                                    (
                                                                        s.clearing_price_e8
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            > (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        and s.oracle_seen
                                                    )
                                                    else s.clearing_price_e8
                                                )
                                            )
                                        )
                                        * (
                                            s.position_base
                                            if (s.position_base >= 0)
                                            else (0 - s.position_base)
                                        )
                                    )
                                    // 100000000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    - s.index_price_e8
                                                )
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    >= s.index_price_e8
                                                )
                                                else (
                                                    s.index_price_e8
                                                    - (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                )
                                            )
                                            * (
                                                s.position_base
                                                if (s.position_base >= 0)
                                                else (0 - s.position_base)
                                            )
                                        )
                                        % 100000000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                        if (
                            (
                                (
                                    (
                                        (
                                            (
                                                0
                                                if 10000 == 0
                                                else (
                                                    (
                                                        (
                                                            9999
                                                            + (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        // 10000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                9999
                                                                + (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            % 10000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                            + s.index_price_e8
                                        )
                                        if (s.clearing_price_e8 >= s.index_price_e8)
                                        else (
                                            s.index_price_e8
                                            - (
                                                0
                                                if 10000 == 0
                                                else (
                                                    (
                                                        (
                                                            9999
                                                            + (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        // 10000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                9999
                                                                + (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            % 10000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                    )
                                    if (
                                        (
                                            (
                                                10000
                                                * (
                                                    (
                                                        s.clearing_price_e8
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        s.clearing_price_e8
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - s.clearing_price_e8
                                                    )
                                                )
                                            )
                                            > (s.index_price_e8 * s.max_oracle_move_bps)
                                        )
                                        and s.oracle_seen
                                    )
                                    else s.clearing_price_e8
                                )
                                >= s.index_price_e8
                            )
                            == (s.position_base >= 0)
                        )
                        else (
                            0
                            - (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    - s.index_price_e8
                                                )
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    >= s.index_price_e8
                                                )
                                                else (
                                                    s.index_price_e8
                                                    - (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                )
                                            )
                                            * (
                                                s.position_base
                                                if (s.position_base >= 0)
                                                else (0 - s.position_base)
                                            )
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                )
                                                * (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                    )
                    + s.collateral_quote
                )
            ),
            depeg_buffer_bps=s.depeg_buffer_bps,
            entry_price_e8=(
                0
                if (
                    (0 == s.position_base)
                    or (
                        (
                            (
                                (
                                    (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                    if (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            0
                                                            if 10000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    // 10000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        % 10000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                        + s.index_price_e8
                                                    )
                                                    if (
                                                        s.clearing_price_e8
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            0
                                                            if 10000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    // 10000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        % 10000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                    )
                                                )
                                                if (
                                                    (
                                                        (
                                                            10000
                                                            * (
                                                                (
                                                                    s.clearing_price_e8
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        > (
                                                            s.index_price_e8
                                                            * s.max_oracle_move_bps
                                                        )
                                                    )
                                                    and s.oracle_seen
                                                )
                                                else s.clearing_price_e8
                                            )
                                            >= s.index_price_e8
                                        )
                                        == (s.position_base >= 0)
                                    )
                                    else (
                                        0
                                        - (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            * (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                )
                                + s.collateral_quote
                            )
                            < (
                                0
                                if 10000 == 0
                                else (
                                    (
                                        (
                                            (
                                                s.depeg_buffer_bps
                                                + s.maintenance_margin_bps
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        // 10000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    s.depeg_buffer_bps
                                                    + s.maintenance_margin_bps
                                                )
                                                * (
                                                    0
                                                    if 100000000 == 0
                                                    else (
                                                        (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            // 100000000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                    * (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                                % 100000000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                            )
                                            % 10000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                        and (not (0 == s.position_base))
                    )
                )
                else (
                    (
                        (
                            (
                                0
                                if 10000 == 0
                                else (
                                    (
                                        (
                                            9999
                                            + (s.index_price_e8 * s.max_oracle_move_bps)
                                        )
                                        // 10000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                9999
                                                + (
                                                    s.index_price_e8
                                                    * s.max_oracle_move_bps
                                                )
                                            )
                                            % 10000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            + s.index_price_e8
                        )
                        if (s.clearing_price_e8 >= s.index_price_e8)
                        else (
                            s.index_price_e8
                            - (
                                0
                                if 10000 == 0
                                else (
                                    (
                                        (
                                            9999
                                            + (s.index_price_e8 * s.max_oracle_move_bps)
                                        )
                                        // 10000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                9999
                                                + (
                                                    s.index_price_e8
                                                    * s.max_oracle_move_bps
                                                )
                                            )
                                            % 10000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                    )
                    if (
                        (
                            (
                                10000
                                * (
                                    (s.clearing_price_e8 - s.index_price_e8)
                                    if (s.clearing_price_e8 >= s.index_price_e8)
                                    else (s.index_price_e8 - s.clearing_price_e8)
                                )
                            )
                            > (s.index_price_e8 * s.max_oracle_move_bps)
                        )
                        and s.oracle_seen
                    )
                    else s.clearing_price_e8
                )
            ),
            fee_income=(
                (
                    (
                        min(
                            (
                                (
                                    (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                    if (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            0
                                                            if 10000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    // 10000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        % 10000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                        + s.index_price_e8
                                                    )
                                                    if (
                                                        s.clearing_price_e8
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            0
                                                            if 10000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    // 10000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        % 10000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                    )
                                                )
                                                if (
                                                    (
                                                        (
                                                            10000
                                                            * (
                                                                (
                                                                    s.clearing_price_e8
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        > (
                                                            s.index_price_e8
                                                            * s.max_oracle_move_bps
                                                        )
                                                    )
                                                    and s.oracle_seen
                                                )
                                                else s.clearing_price_e8
                                            )
                                            >= s.index_price_e8
                                        )
                                        == (s.position_base >= 0)
                                    )
                                    else (
                                        0
                                        - (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            * (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                )
                                + s.collateral_quote
                            ),
                            (
                                0
                                if 10000 == 0
                                else (
                                    (
                                        (
                                            (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                            * s.liquidation_penalty_bps
                                        )
                                        // 10000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    0
                                                    if 100000000 == 0
                                                    else (
                                                        (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            // 100000000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                    * (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                                % 100000000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                                * s.liquidation_penalty_bps
                                            )
                                            % 10000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            ),
                        )
                        if (
                            (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                s.position_base
                                                if (s.position_base >= 0)
                                                else (0 - s.position_base)
                                            )
                                            * (
                                                (
                                                    (
                                                        (
                                                            0
                                                            if 10000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    // 10000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        % 10000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                        + s.index_price_e8
                                                    )
                                                    if (
                                                        s.clearing_price_e8
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            0
                                                            if 10000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    // 10000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        % 10000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                    )
                                                )
                                                if (
                                                    (
                                                        (
                                                            10000
                                                            * (
                                                                (
                                                                    s.clearing_price_e8
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        > (
                                                            s.index_price_e8
                                                            * s.max_oracle_move_bps
                                                        )
                                                    )
                                                    and s.oracle_seen
                                                )
                                                else s.clearing_price_e8
                                            )
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                                * (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            + s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                10000
                                                                * (
                                                                    (
                                                                        s.clearing_price_e8
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            > (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        and s.oracle_seen
                                                    )
                                                    else s.clearing_price_e8
                                                )
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            >= s.min_notional_for_bounty
                        )
                        else 0
                    )
                    + s.fee_income
                )
                if (
                    (
                        (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                )
                                                * (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                if (
                                    (
                                        (
                                            (
                                                (
                                                    (
                                                        0
                                                        if 10000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                // 10000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    % 10000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                    + s.index_price_e8
                                                )
                                                if (
                                                    s.clearing_price_e8
                                                    >= s.index_price_e8
                                                )
                                                else (
                                                    s.index_price_e8
                                                    - (
                                                        0
                                                        if 10000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                // 10000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    % 10000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                )
                                            )
                                            if (
                                                (
                                                    (
                                                        10000
                                                        * (
                                                            (
                                                                s.clearing_price_e8
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    > (
                                                        s.index_price_e8
                                                        * s.max_oracle_move_bps
                                                    )
                                                )
                                                and s.oracle_seen
                                            )
                                            else s.clearing_price_e8
                                        )
                                        >= s.index_price_e8
                                    )
                                    == (s.position_base >= 0)
                                )
                                else (
                                    0
                                    - (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                            )
                            + s.collateral_quote
                        )
                        < (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (
                                        (s.depeg_buffer_bps + s.maintenance_margin_bps)
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                s.depeg_buffer_bps
                                                + s.maintenance_margin_bps
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                    )
                    and (not (0 == s.position_base))
                )
                else s.fee_income
            ),
            fee_pool_quote=(
                (
                    (
                        min(
                            (
                                (
                                    (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                    if (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            0
                                                            if 10000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    // 10000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        % 10000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                        + s.index_price_e8
                                                    )
                                                    if (
                                                        s.clearing_price_e8
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            0
                                                            if 10000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    // 10000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        % 10000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                    )
                                                )
                                                if (
                                                    (
                                                        (
                                                            10000
                                                            * (
                                                                (
                                                                    s.clearing_price_e8
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        > (
                                                            s.index_price_e8
                                                            * s.max_oracle_move_bps
                                                        )
                                                    )
                                                    and s.oracle_seen
                                                )
                                                else s.clearing_price_e8
                                            )
                                            >= s.index_price_e8
                                        )
                                        == (s.position_base >= 0)
                                    )
                                    else (
                                        0
                                        - (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            * (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                )
                                + s.collateral_quote
                            ),
                            (
                                0
                                if 10000 == 0
                                else (
                                    (
                                        (
                                            (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                            * s.liquidation_penalty_bps
                                        )
                                        // 10000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    0
                                                    if 100000000 == 0
                                                    else (
                                                        (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            // 100000000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                    * (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                                % 100000000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                                * s.liquidation_penalty_bps
                                            )
                                            % 10000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            ),
                        )
                        if (
                            (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                s.position_base
                                                if (s.position_base >= 0)
                                                else (0 - s.position_base)
                                            )
                                            * (
                                                (
                                                    (
                                                        (
                                                            0
                                                            if 10000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    // 10000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        % 10000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                        + s.index_price_e8
                                                    )
                                                    if (
                                                        s.clearing_price_e8
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            0
                                                            if 10000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    // 10000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        % 10000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                    )
                                                )
                                                if (
                                                    (
                                                        (
                                                            10000
                                                            * (
                                                                (
                                                                    s.clearing_price_e8
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        > (
                                                            s.index_price_e8
                                                            * s.max_oracle_move_bps
                                                        )
                                                    )
                                                    and s.oracle_seen
                                                )
                                                else s.clearing_price_e8
                                            )
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                                * (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            + s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                10000
                                                                * (
                                                                    (
                                                                        s.clearing_price_e8
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            > (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        and s.oracle_seen
                                                    )
                                                    else s.clearing_price_e8
                                                )
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            >= s.min_notional_for_bounty
                        )
                        else 0
                    )
                    + s.fee_pool_quote
                )
                if (
                    (
                        (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                )
                                                * (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                if (
                                    (
                                        (
                                            (
                                                (
                                                    (
                                                        0
                                                        if 10000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                // 10000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    % 10000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                    + s.index_price_e8
                                                )
                                                if (
                                                    s.clearing_price_e8
                                                    >= s.index_price_e8
                                                )
                                                else (
                                                    s.index_price_e8
                                                    - (
                                                        0
                                                        if 10000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                // 10000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    % 10000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                )
                                            )
                                            if (
                                                (
                                                    (
                                                        10000
                                                        * (
                                                            (
                                                                s.clearing_price_e8
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    > (
                                                        s.index_price_e8
                                                        * s.max_oracle_move_bps
                                                    )
                                                )
                                                and s.oracle_seen
                                            )
                                            else s.clearing_price_e8
                                        )
                                        >= s.index_price_e8
                                    )
                                    == (s.position_base >= 0)
                                )
                                else (
                                    0
                                    - (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                            )
                            + s.collateral_quote
                        )
                        < (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (
                                        (s.depeg_buffer_bps + s.maintenance_margin_bps)
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                s.depeg_buffer_bps
                                                + s.maintenance_margin_bps
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                    )
                    and (not (0 == s.position_base))
                )
                else s.fee_pool_quote
            ),
            funding_cap_bps=s.funding_cap_bps,
            funding_last_applied_epoch=s.funding_last_applied_epoch,
            funding_paid_cumulative=s.funding_paid_cumulative,
            funding_rate_bps=s.funding_rate_bps,
            index_price_e8=(
                (
                    (
                        (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (9999 + (s.index_price_e8 * s.max_oracle_move_bps))
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            9999
                                            + (s.index_price_e8 * s.max_oracle_move_bps)
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                        + s.index_price_e8
                    )
                    if (s.clearing_price_e8 >= s.index_price_e8)
                    else (
                        s.index_price_e8
                        - (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (9999 + (s.index_price_e8 * s.max_oracle_move_bps))
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            9999
                                            + (s.index_price_e8 * s.max_oracle_move_bps)
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                    )
                )
                if (
                    (
                        (
                            10000
                            * (
                                (s.clearing_price_e8 - s.index_price_e8)
                                if (s.clearing_price_e8 >= s.index_price_e8)
                                else (s.index_price_e8 - s.clearing_price_e8)
                            )
                        )
                        > (s.index_price_e8 * s.max_oracle_move_bps)
                    )
                    and s.oracle_seen
                )
                else s.clearing_price_e8
            ),
            initial_insurance=s.initial_insurance,
            initial_margin_bps=s.initial_margin_bps,
            insurance_balance=(
                (
                    (
                        (
                            (
                                min(
                                    (
                                        (
                                            (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            * (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                * (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                            if (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    >= s.index_price_e8
                                                )
                                                == (s.position_base >= 0)
                                            )
                                            else (
                                                0
                                                - (
                                                    0
                                                    if 100000000 == 0
                                                    else (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                * (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                            )
                                                            // 100000000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        + s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                                if (
                                                                                    (
                                                                                        (
                                                                                            10000
                                                                                            * (
                                                                                                (
                                                                                                    s.clearing_price_e8
                                                                                                    - s.index_price_e8
                                                                                                )
                                                                                                if (
                                                                                                    s.clearing_price_e8
                                                                                                    >= s.index_price_e8
                                                                                                )
                                                                                                else (
                                                                                                    s.index_price_e8
                                                                                                    - s.clearing_price_e8
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        > (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    and s.oracle_seen
                                                                                )
                                                                                else s.clearing_price_e8
                                                                            )
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        + s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                                if (
                                                                                    (
                                                                                        (
                                                                                            10000
                                                                                            * (
                                                                                                (
                                                                                                    s.clearing_price_e8
                                                                                                    - s.index_price_e8
                                                                                                )
                                                                                                if (
                                                                                                    s.clearing_price_e8
                                                                                                    >= s.index_price_e8
                                                                                                )
                                                                                                else (
                                                                                                    s.index_price_e8
                                                                                                    - s.clearing_price_e8
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        > (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    and s.oracle_seen
                                                                                )
                                                                                else s.clearing_price_e8
                                                                            )
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        + s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                                if (
                                                                                    (
                                                                                        (
                                                                                            10000
                                                                                            * (
                                                                                                (
                                                                                                    s.clearing_price_e8
                                                                                                    - s.index_price_e8
                                                                                                )
                                                                                                if (
                                                                                                    s.clearing_price_e8
                                                                                                    >= s.index_price_e8
                                                                                                )
                                                                                                else (
                                                                                                    s.index_price_e8
                                                                                                    - s.clearing_price_e8
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        > (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    and s.oracle_seen
                                                                                )
                                                                                else s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    * (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                )
                                                                % 100000000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                            )
                                        )
                                        + s.collateral_quote
                                    ),
                                    (
                                        0
                                        if 10000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        0
                                                        if 100000000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                    * (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                                // 100000000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        (
                                                                            s.position_base
                                                                            if (
                                                                                s.position_base
                                                                                >= 0
                                                                            )
                                                                            else (
                                                                                0
                                                                                - s.position_base
                                                                            )
                                                                        )
                                                                        * (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                    )
                                                                    % 100000000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                    * s.liquidation_penalty_bps
                                                )
                                                // 10000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            0
                                                            if 100000000 == 0
                                                            else (
                                                                (
                                                                    (
                                                                        (
                                                                            s.position_base
                                                                            if (
                                                                                s.position_base
                                                                                >= 0
                                                                            )
                                                                            else (
                                                                                0
                                                                                - s.position_base
                                                                            )
                                                                        )
                                                                        * (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                    )
                                                                    // 100000000
                                                                )
                                                                + (
                                                                    1
                                                                    if (
                                                                        (
                                                                            (
                                                                                s.position_base
                                                                                if (
                                                                                    s.position_base
                                                                                    >= 0
                                                                                )
                                                                                else (
                                                                                    0
                                                                                    - s.position_base
                                                                                )
                                                                            )
                                                                            * (
                                                                                (
                                                                                    (
                                                                                        (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        + s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - (
                                                                                            0
                                                                                            if 10000
                                                                                            == 0
                                                                                            else (
                                                                                                (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    // 10000
                                                                                                )
                                                                                                + (
                                                                                                    1
                                                                                                    if (
                                                                                                        (
                                                                                                            9999
                                                                                                            + (
                                                                                                                s.index_price_e8
                                                                                                                * s.max_oracle_move_bps
                                                                                                            )
                                                                                                        )
                                                                                                        % 10000
                                                                                                    )
                                                                                                    < 0
                                                                                                    else 0
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                                if (
                                                                                    (
                                                                                        (
                                                                                            10000
                                                                                            * (
                                                                                                (
                                                                                                    s.clearing_price_e8
                                                                                                    - s.index_price_e8
                                                                                                )
                                                                                                if (
                                                                                                    s.clearing_price_e8
                                                                                                    >= s.index_price_e8
                                                                                                )
                                                                                                else (
                                                                                                    s.index_price_e8
                                                                                                    - s.clearing_price_e8
                                                                                                )
                                                                                            )
                                                                                        )
                                                                                        > (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    and s.oracle_seen
                                                                                )
                                                                                else s.clearing_price_e8
                                                                            )
                                                                        )
                                                                        % 100000000
                                                                    )
                                                                    < 0
                                                                    else 0
                                                                )
                                                            )
                                                        )
                                                        * s.liquidation_penalty_bps
                                                    )
                                                    % 10000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    ),
                                )
                                if (
                                    (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                    * (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                    >= s.min_notional_for_bounty
                                )
                                else 0
                            )
                            + s.fee_income
                        )
                        if (
                            (
                                (
                                    (
                                        (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            * (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                        if (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                            + s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                0
                                                                if 10000 == 0
                                                                else (
                                                                    (
                                                                        (
                                                                            9999
                                                                            + (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        // 10000
                                                                    )
                                                                    + (
                                                                        1
                                                                        if (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            % 10000
                                                                        )
                                                                        < 0
                                                                        else 0
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                10000
                                                                * (
                                                                    (
                                                                        s.clearing_price_e8
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            > (
                                                                s.index_price_e8
                                                                * s.max_oracle_move_bps
                                                            )
                                                        )
                                                        and s.oracle_seen
                                                    )
                                                    else s.clearing_price_e8
                                                )
                                                >= s.index_price_e8
                                            )
                                            == (s.position_base >= 0)
                                        )
                                        else (
                                            0
                                            - (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    - s.index_price_e8
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                            )
                                                            * (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                        - s.index_price_e8
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                * (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                    )
                                    + s.collateral_quote
                                )
                                < (
                                    0
                                    if 10000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    s.depeg_buffer_bps
                                                    + s.maintenance_margin_bps
                                                )
                                                * (
                                                    0
                                                    if 100000000 == 0
                                                    else (
                                                        (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            // 100000000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                    * (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                                % 100000000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                            )
                                            // 10000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        s.depeg_buffer_bps
                                                        + s.maintenance_margin_bps
                                                    )
                                                    * (
                                                        0
                                                        if 100000000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    (
                                                                        s.position_base
                                                                        if (
                                                                            s.position_base
                                                                            >= 0
                                                                        )
                                                                        else (
                                                                            0
                                                                            - s.position_base
                                                                        )
                                                                    )
                                                                    * (
                                                                        (
                                                                            (
                                                                                (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                                + s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - (
                                                                                    0
                                                                                    if 10000
                                                                                    == 0
                                                                                    else (
                                                                                        (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            // 10000
                                                                                        )
                                                                                        + (
                                                                                            1
                                                                                            if (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                % 10000
                                                                                            )
                                                                                            < 0
                                                                                            else 0
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                        if (
                                                                            (
                                                                                (
                                                                                    10000
                                                                                    * (
                                                                                        (
                                                                                            s.clearing_price_e8
                                                                                            - s.index_price_e8
                                                                                        )
                                                                                        if (
                                                                                            s.clearing_price_e8
                                                                                            >= s.index_price_e8
                                                                                        )
                                                                                        else (
                                                                                            s.index_price_e8
                                                                                            - s.clearing_price_e8
                                                                                        )
                                                                                    )
                                                                                )
                                                                                > (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            and s.oracle_seen
                                                                        )
                                                                        else s.clearing_price_e8
                                                                    )
                                                                )
                                                                // 100000000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        (
                                                                            s.position_base
                                                                            if (
                                                                                s.position_base
                                                                                >= 0
                                                                            )
                                                                            else (
                                                                                0
                                                                                - s.position_base
                                                                            )
                                                                        )
                                                                        * (
                                                                            (
                                                                                (
                                                                                    (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    + s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - (
                                                                                        0
                                                                                        if 10000
                                                                                        == 0
                                                                                        else (
                                                                                            (
                                                                                                (
                                                                                                    9999
                                                                                                    + (
                                                                                                        s.index_price_e8
                                                                                                        * s.max_oracle_move_bps
                                                                                                    )
                                                                                                )
                                                                                                // 10000
                                                                                            )
                                                                                            + (
                                                                                                1
                                                                                                if (
                                                                                                    (
                                                                                                        9999
                                                                                                        + (
                                                                                                            s.index_price_e8
                                                                                                            * s.max_oracle_move_bps
                                                                                                        )
                                                                                                    )
                                                                                                    % 10000
                                                                                                )
                                                                                                < 0
                                                                                                else 0
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                            if (
                                                                                (
                                                                                    (
                                                                                        10000
                                                                                        * (
                                                                                            (
                                                                                                s.clearing_price_e8
                                                                                                - s.index_price_e8
                                                                                            )
                                                                                            if (
                                                                                                s.clearing_price_e8
                                                                                                >= s.index_price_e8
                                                                                            )
                                                                                            else (
                                                                                                s.index_price_e8
                                                                                                - s.clearing_price_e8
                                                                                            )
                                                                                        )
                                                                                    )
                                                                                    > (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                and s.oracle_seen
                                                                            )
                                                                            else s.clearing_price_e8
                                                                        )
                                                                    )
                                                                    % 100000000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                )
                                                % 10000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                            )
                            and (not (0 == s.position_base))
                        )
                        else s.fee_income
                    )
                    + s.initial_insurance
                )
                - s.claims_paid
            ),
            liquidated_this_step=(
                (
                    (
                        (
                            (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    - s.index_price_e8
                                                )
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                    >= s.index_price_e8
                                                )
                                                else (
                                                    s.index_price_e8
                                                    - (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                )
                                            )
                                            * (
                                                s.position_base
                                                if (s.position_base >= 0)
                                                else (0 - s.position_base)
                                            )
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                )
                                                * (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            if (
                                (
                                    (
                                        (
                                            (
                                                (
                                                    0
                                                    if 10000 == 0
                                                    else (
                                                        (
                                                            (
                                                                9999
                                                                + (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            // 10000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                % 10000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                                + s.index_price_e8
                                            )
                                            if (s.clearing_price_e8 >= s.index_price_e8)
                                            else (
                                                s.index_price_e8
                                                - (
                                                    0
                                                    if 10000 == 0
                                                    else (
                                                        (
                                                            (
                                                                9999
                                                                + (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            // 10000
                                                        )
                                                        + (
                                                            1
                                                            if (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                % 10000
                                                            )
                                                            < 0
                                                            else 0
                                                        )
                                                    )
                                                )
                                            )
                                        )
                                        if (
                                            (
                                                (
                                                    10000
                                                    * (
                                                        (
                                                            s.clearing_price_e8
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            s.clearing_price_e8
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - s.clearing_price_e8
                                                        )
                                                    )
                                                )
                                                > (
                                                    s.index_price_e8
                                                    * s.max_oracle_move_bps
                                                )
                                            )
                                            and s.oracle_seen
                                        )
                                        else s.clearing_price_e8
                                    )
                                    >= s.index_price_e8
                                )
                                == (s.position_base >= 0)
                            )
                            else (
                                0
                                - (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                )
                                                * (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                            )
                        )
                        + s.collateral_quote
                    )
                    < (
                        0
                        if 10000 == 0
                        else (
                            (
                                (
                                    (s.depeg_buffer_bps + s.maintenance_margin_bps)
                                    * (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                    * (
                                                        (
                                                            (
                                                                (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                                + s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    0
                                                                    if 10000 == 0
                                                                    else (
                                                                        (
                                                                            (
                                                                                9999
                                                                                + (
                                                                                    s.index_price_e8
                                                                                    * s.max_oracle_move_bps
                                                                                )
                                                                            )
                                                                            // 10000
                                                                        )
                                                                        + (
                                                                            1
                                                                            if (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                % 10000
                                                                            )
                                                                            < 0
                                                                            else 0
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    10000
                                                                    * (
                                                                        (
                                                                            s.clearing_price_e8
                                                                            - s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - s.clearing_price_e8
                                                                        )
                                                                    )
                                                                )
                                                                > (
                                                                    s.index_price_e8
                                                                    * s.max_oracle_move_bps
                                                                )
                                                            )
                                                            and s.oracle_seen
                                                        )
                                                        else s.clearing_price_e8
                                                    )
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                                // 10000
                            )
                            + (
                                1
                                if (
                                    (
                                        (s.depeg_buffer_bps + s.maintenance_margin_bps)
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    % 10000
                                )
                                < 0
                                else 0
                            )
                        )
                    )
                )
                and (not (0 == s.position_base))
            ),
            liquidation_penalty_bps=s.liquidation_penalty_bps,
            maintenance_margin_bps=s.maintenance_margin_bps,
            max_oracle_move_bps=s.max_oracle_move_bps,
            max_oracle_staleness_epochs=s.max_oracle_staleness_epochs,
            max_position_abs=s.max_position_abs,
            min_notional_for_bounty=s.min_notional_for_bounty,
            now_epoch=s.now_epoch,
            oracle_last_update_epoch=s.now_epoch,
            oracle_seen=True,
            position_base=(
                0
                if (
                    (
                        (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        - s.index_price_e8
                                                    )
                                                    if (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                        >= s.index_price_e8
                                                    )
                                                    else (
                                                        s.index_price_e8
                                                        - (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                )
                                                * (
                                                    s.position_base
                                                    if (s.position_base >= 0)
                                                    else (0 - s.position_base)
                                                )
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                if (
                                    (
                                        (
                                            (
                                                (
                                                    (
                                                        0
                                                        if 10000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                // 10000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    % 10000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                    + s.index_price_e8
                                                )
                                                if (
                                                    s.clearing_price_e8
                                                    >= s.index_price_e8
                                                )
                                                else (
                                                    s.index_price_e8
                                                    - (
                                                        0
                                                        if 10000 == 0
                                                        else (
                                                            (
                                                                (
                                                                    9999
                                                                    + (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                // 10000
                                                            )
                                                            + (
                                                                1
                                                                if (
                                                                    (
                                                                        9999
                                                                        + (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    % 10000
                                                                )
                                                                < 0
                                                                else 0
                                                            )
                                                        )
                                                    )
                                                )
                                            )
                                            if (
                                                (
                                                    (
                                                        10000
                                                        * (
                                                            (
                                                                s.clearing_price_e8
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                s.clearing_price_e8
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    > (
                                                        s.index_price_e8
                                                        * s.max_oracle_move_bps
                                                    )
                                                )
                                                and s.oracle_seen
                                            )
                                            else s.clearing_price_e8
                                        )
                                        >= s.index_price_e8
                                    )
                                    == (s.position_base >= 0)
                                )
                                else (
                                    0
                                    - (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            - s.index_price_e8
                                                        )
                                                        if (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                            >= s.index_price_e8
                                                        )
                                                        else (
                                                            s.index_price_e8
                                                            - (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                    )
                                                    * (
                                                        s.position_base
                                                        if (s.position_base >= 0)
                                                        else (0 - s.position_base)
                                                    )
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                - s.index_price_e8
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                                >= s.index_price_e8
                                                            )
                                                            else (
                                                                s.index_price_e8
                                                                - (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                        )
                                                        * (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                            )
                            + s.collateral_quote
                        )
                        < (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (
                                        (s.depeg_buffer_bps + s.maintenance_margin_bps)
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * (
                                                            (
                                                                (
                                                                    (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                    + s.index_price_e8
                                                                )
                                                                if (
                                                                    s.clearing_price_e8
                                                                    >= s.index_price_e8
                                                                )
                                                                else (
                                                                    s.index_price_e8
                                                                    - (
                                                                        0
                                                                        if 10000 == 0
                                                                        else (
                                                                            (
                                                                                (
                                                                                    9999
                                                                                    + (
                                                                                        s.index_price_e8
                                                                                        * s.max_oracle_move_bps
                                                                                    )
                                                                                )
                                                                                // 10000
                                                                            )
                                                                            + (
                                                                                1
                                                                                if (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    % 10000
                                                                                )
                                                                                < 0
                                                                                else 0
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            )
                                                            if (
                                                                (
                                                                    (
                                                                        10000
                                                                        * (
                                                                            (
                                                                                s.clearing_price_e8
                                                                                - s.index_price_e8
                                                                            )
                                                                            if (
                                                                                s.clearing_price_e8
                                                                                >= s.index_price_e8
                                                                            )
                                                                            else (
                                                                                s.index_price_e8
                                                                                - s.clearing_price_e8
                                                                            )
                                                                        )
                                                                    )
                                                                    > (
                                                                        s.index_price_e8
                                                                        * s.max_oracle_move_bps
                                                                    )
                                                                )
                                                                and s.oracle_seen
                                                            )
                                                            else s.clearing_price_e8
                                                        )
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                s.depeg_buffer_bps
                                                + s.maintenance_margin_bps
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * (
                                                                (
                                                                    (
                                                                        (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                        + s.index_price_e8
                                                                    )
                                                                    if (
                                                                        s.clearing_price_e8
                                                                        >= s.index_price_e8
                                                                    )
                                                                    else (
                                                                        s.index_price_e8
                                                                        - (
                                                                            0
                                                                            if 10000
                                                                            == 0
                                                                            else (
                                                                                (
                                                                                    (
                                                                                        9999
                                                                                        + (
                                                                                            s.index_price_e8
                                                                                            * s.max_oracle_move_bps
                                                                                        )
                                                                                    )
                                                                                    // 10000
                                                                                )
                                                                                + (
                                                                                    1
                                                                                    if (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        % 10000
                                                                                    )
                                                                                    < 0
                                                                                    else 0
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                                if (
                                                                    (
                                                                        (
                                                                            10000
                                                                            * (
                                                                                (
                                                                                    s.clearing_price_e8
                                                                                    - s.index_price_e8
                                                                                )
                                                                                if (
                                                                                    s.clearing_price_e8
                                                                                    >= s.index_price_e8
                                                                                )
                                                                                else (
                                                                                    s.index_price_e8
                                                                                    - s.clearing_price_e8
                                                                                )
                                                                            )
                                                                        )
                                                                        > (
                                                                            s.index_price_e8
                                                                            * s.max_oracle_move_bps
                                                                        )
                                                                    )
                                                                    and s.oracle_seen
                                                                )
                                                                else s.clearing_price_e8
                                                            )
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * (
                                                                    (
                                                                        (
                                                                            (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                            + s.index_price_e8
                                                                        )
                                                                        if (
                                                                            s.clearing_price_e8
                                                                            >= s.index_price_e8
                                                                        )
                                                                        else (
                                                                            s.index_price_e8
                                                                            - (
                                                                                0
                                                                                if 10000
                                                                                == 0
                                                                                else (
                                                                                    (
                                                                                        (
                                                                                            9999
                                                                                            + (
                                                                                                s.index_price_e8
                                                                                                * s.max_oracle_move_bps
                                                                                            )
                                                                                        )
                                                                                        // 10000
                                                                                    )
                                                                                    + (
                                                                                        1
                                                                                        if (
                                                                                            (
                                                                                                9999
                                                                                                + (
                                                                                                    s.index_price_e8
                                                                                                    * s.max_oracle_move_bps
                                                                                                )
                                                                                            )
                                                                                            % 10000
                                                                                        )
                                                                                        < 0
                                                                                        else 0
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                    if (
                                                                        (
                                                                            (
                                                                                10000
                                                                                * (
                                                                                    (
                                                                                        s.clearing_price_e8
                                                                                        - s.index_price_e8
                                                                                    )
                                                                                    if (
                                                                                        s.clearing_price_e8
                                                                                        >= s.index_price_e8
                                                                                    )
                                                                                    else (
                                                                                        s.index_price_e8
                                                                                        - s.clearing_price_e8
                                                                                    )
                                                                                )
                                                                            )
                                                                            > (
                                                                                s.index_price_e8
                                                                                * s.max_oracle_move_bps
                                                                            )
                                                                        )
                                                                        and s.oracle_seen
                                                                    )
                                                                    else s.clearing_price_e8
                                                                )
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                    )
                    and (not (0 == s.position_base))
                )
                else s.position_base
            ),
        )
        effects = {
            "collateral_after": new_state.collateral_quote,
            "effective_maint_bps": (
                new_state.depeg_buffer_bps + new_state.maintenance_margin_bps
            ),
            "event": "EpochSettled",
            "fee_pool_after": new_state.fee_pool_quote,
            "init_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            * new_state.initial_margin_bps
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                * new_state.initial_margin_bps
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "insurance_after": new_state.insurance_balance,
            "liquidated": new_state.liquidated_this_step,
            "maint_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                new_state.depeg_buffer_bps
                                + new_state.maintenance_margin_bps
                            )
                            * (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.depeg_buffer_bps
                                    + new_state.maintenance_margin_bps
                                )
                                * (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "margin_ok": (
                True
                if (0 == new_state.position_base)
                else (
                    new_state.collateral_quote
                    >= (
                        0
                        if 10000 == 0
                        else (
                            (
                                (
                                    (
                                        new_state.depeg_buffer_bps
                                        + new_state.maintenance_margin_bps
                                    )
                                    * (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                                // 10000
                            )
                            + (
                                1
                                if (
                                    (
                                        (
                                            new_state.depeg_buffer_bps
                                            + new_state.maintenance_margin_bps
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                new_state.position_base
                                                                if (
                                                                    new_state.position_base
                                                                    >= 0
                                                                )
                                                                else (
                                                                    0
                                                                    - new_state.position_base
                                                                )
                                                            )
                                                            * new_state.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    % 10000
                                )
                                < 0
                                else 0
                            )
                        )
                    )
                )
            ),
            "notional_quote": (
                0
                if 100000000 == 0
                else (
                    (
                        (
                            (
                                new_state.position_base
                                if (new_state.position_base >= 0)
                                else (0 - new_state.position_base)
                            )
                            * new_state.index_price_e8
                        )
                        // 100000000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.position_base
                                    if (new_state.position_base >= 0)
                                    else (0 - new_state.position_base)
                                )
                                * new_state.index_price_e8
                            )
                            % 100000000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "oracle_fresh": True,
        }
        ok, failed = check_invariants(new_state)
        if not ok:
            return StepResult(ok=False, error=f"post-invariant violated: {failed}")
        return StepResult(ok=True, state=new_state, effects=effects)
    elif cmd.tag == "withdraw_collateral":
        if "amount" not in cmd.args or not (
            isinstance(cmd.args["amount"], int)
            and not isinstance(cmd.args["amount"], bool)
            and 1 <= cmd.args["amount"] <= 1000000000000
        ):
            return StepResult(ok=False, error="invalid param amount")
        if "auth_ok" not in cmd.args or not (isinstance(cmd.args["auth_ok"], bool)):
            return StepResult(ok=False, error="invalid param auth_ok")
        if not (
            (
                True
                if (0 == s.position_base)
                else (
                    (
                        (s.now_epoch - s.oracle_last_update_epoch)
                        <= s.max_oracle_staleness_epochs
                    )
                    and (
                        (s.collateral_quote - cmd.args["amount"])
                        >= (
                            0
                            if 10000 == 0
                            else (
                                (
                                    (
                                        (s.depeg_buffer_bps + s.maintenance_margin_bps)
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            s.position_base
                                                            if (s.position_base >= 0)
                                                            else (0 - s.position_base)
                                                        )
                                                        * s.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    // 10000
                                )
                                + (
                                    1
                                    if (
                                        (
                                            (
                                                s.depeg_buffer_bps
                                                + s.maintenance_margin_bps
                                            )
                                            * (
                                                0
                                                if 100000000 == 0
                                                else (
                                                    (
                                                        (
                                                            (
                                                                s.position_base
                                                                if (
                                                                    s.position_base >= 0
                                                                )
                                                                else (
                                                                    0 - s.position_base
                                                                )
                                                            )
                                                            * s.index_price_e8
                                                        )
                                                        // 100000000
                                                    )
                                                    + (
                                                        1
                                                        if (
                                                            (
                                                                (
                                                                    s.position_base
                                                                    if (
                                                                        s.position_base
                                                                        >= 0
                                                                    )
                                                                    else (
                                                                        0
                                                                        - s.position_base
                                                                    )
                                                                )
                                                                * s.index_price_e8
                                                            )
                                                            % 100000000
                                                        )
                                                        < 0
                                                        else 0
                                                    )
                                                )
                                            )
                                        )
                                        % 10000
                                    )
                                    < 0
                                    else 0
                                )
                            )
                        )
                    )
                    and s.oracle_seen
                )
            )
            and (cmd.args["amount"] <= s.collateral_quote)
            and (True == cmd.args["auth_ok"])
        ):
            return StepResult(ok=False, error="guard failed for withdraw_collateral")
        # Compute updates (simultaneous)
        new_state = State(
            breaker_active=s.breaker_active,
            breaker_last_trigger_epoch=s.breaker_last_trigger_epoch,
            claims_paid=s.claims_paid,
            clearing_price_e8=s.clearing_price_e8,
            clearing_price_epoch=s.clearing_price_epoch,
            clearing_price_seen=s.clearing_price_seen,
            collateral_quote=(s.collateral_quote - cmd.args["amount"]),
            depeg_buffer_bps=s.depeg_buffer_bps,
            entry_price_e8=s.entry_price_e8,
            fee_income=s.fee_income,
            fee_pool_quote=s.fee_pool_quote,
            funding_cap_bps=s.funding_cap_bps,
            funding_last_applied_epoch=s.funding_last_applied_epoch,
            funding_paid_cumulative=s.funding_paid_cumulative,
            funding_rate_bps=s.funding_rate_bps,
            index_price_e8=s.index_price_e8,
            initial_insurance=s.initial_insurance,
            initial_margin_bps=s.initial_margin_bps,
            insurance_balance=s.insurance_balance,
            liquidated_this_step=False,
            liquidation_penalty_bps=s.liquidation_penalty_bps,
            maintenance_margin_bps=s.maintenance_margin_bps,
            max_oracle_move_bps=s.max_oracle_move_bps,
            max_oracle_staleness_epochs=s.max_oracle_staleness_epochs,
            max_position_abs=s.max_position_abs,
            min_notional_for_bounty=s.min_notional_for_bounty,
            now_epoch=s.now_epoch,
            oracle_last_update_epoch=s.oracle_last_update_epoch,
            oracle_seen=s.oracle_seen,
            position_base=s.position_base,
        )
        effects = {
            "collateral_after": new_state.collateral_quote,
            "effective_maint_bps": (
                new_state.depeg_buffer_bps + new_state.maintenance_margin_bps
            ),
            "event": "CollateralWithdrawn",
            "fee_pool_after": new_state.fee_pool_quote,
            "init_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                            * new_state.initial_margin_bps
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                                * new_state.initial_margin_bps
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "insurance_after": new_state.insurance_balance,
            "liquidated": new_state.liquidated_this_step,
            "maint_req_quote": (
                0
                if 10000 == 0
                else (
                    (
                        (
                            (
                                new_state.depeg_buffer_bps
                                + new_state.maintenance_margin_bps
                            )
                            * (
                                0
                                if 100000000 == 0
                                else (
                                    (
                                        (
                                            (
                                                new_state.position_base
                                                if (new_state.position_base >= 0)
                                                else (0 - new_state.position_base)
                                            )
                                            * new_state.index_price_e8
                                        )
                                        // 100000000
                                    )
                                    + (
                                        1
                                        if (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            % 100000000
                                        )
                                        < 0
                                        else 0
                                    )
                                )
                            )
                        )
                        // 10000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.depeg_buffer_bps
                                    + new_state.maintenance_margin_bps
                                )
                                * (
                                    0
                                    if 100000000 == 0
                                    else (
                                        (
                                            (
                                                (
                                                    new_state.position_base
                                                    if (new_state.position_base >= 0)
                                                    else (0 - new_state.position_base)
                                                )
                                                * new_state.index_price_e8
                                            )
                                            // 100000000
                                        )
                                        + (
                                            1
                                            if (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                % 100000000
                                            )
                                            < 0
                                            else 0
                                        )
                                    )
                                )
                            )
                            % 10000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "margin_ok": (
                True
                if (0 == new_state.position_base)
                else (
                    new_state.collateral_quote
                    >= (
                        0
                        if 10000 == 0
                        else (
                            (
                                (
                                    (
                                        new_state.depeg_buffer_bps
                                        + new_state.maintenance_margin_bps
                                    )
                                    * (
                                        0
                                        if 100000000 == 0
                                        else (
                                            (
                                                (
                                                    (
                                                        new_state.position_base
                                                        if (
                                                            new_state.position_base >= 0
                                                        )
                                                        else (
                                                            0 - new_state.position_base
                                                        )
                                                    )
                                                    * new_state.index_price_e8
                                                )
                                                // 100000000
                                            )
                                            + (
                                                1
                                                if (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    % 100000000
                                                )
                                                < 0
                                                else 0
                                            )
                                        )
                                    )
                                )
                                // 10000
                            )
                            + (
                                1
                                if (
                                    (
                                        (
                                            new_state.depeg_buffer_bps
                                            + new_state.maintenance_margin_bps
                                        )
                                        * (
                                            0
                                            if 100000000 == 0
                                            else (
                                                (
                                                    (
                                                        (
                                                            new_state.position_base
                                                            if (
                                                                new_state.position_base
                                                                >= 0
                                                            )
                                                            else (
                                                                0
                                                                - new_state.position_base
                                                            )
                                                        )
                                                        * new_state.index_price_e8
                                                    )
                                                    // 100000000
                                                )
                                                + (
                                                    1
                                                    if (
                                                        (
                                                            (
                                                                new_state.position_base
                                                                if (
                                                                    new_state.position_base
                                                                    >= 0
                                                                )
                                                                else (
                                                                    0
                                                                    - new_state.position_base
                                                                )
                                                            )
                                                            * new_state.index_price_e8
                                                        )
                                                        % 100000000
                                                    )
                                                    < 0
                                                    else 0
                                                )
                                            )
                                        )
                                    )
                                    % 10000
                                )
                                < 0
                                else 0
                            )
                        )
                    )
                )
            ),
            "notional_quote": (
                0
                if 100000000 == 0
                else (
                    (
                        (
                            (
                                new_state.position_base
                                if (new_state.position_base >= 0)
                                else (0 - new_state.position_base)
                            )
                            * new_state.index_price_e8
                        )
                        // 100000000
                    )
                    + (
                        1
                        if (
                            (
                                (
                                    new_state.position_base
                                    if (new_state.position_base >= 0)
                                    else (0 - new_state.position_base)
                                )
                                * new_state.index_price_e8
                            )
                            % 100000000
                        )
                        < 0
                        else 0
                    )
                )
            ),
            "oracle_fresh": (
                (
                    (new_state.now_epoch - new_state.oracle_last_update_epoch)
                    <= new_state.max_oracle_staleness_epochs
                )
                and new_state.oracle_seen
            ),
        }
        ok, failed = check_invariants(new_state)
        if not ok:
            return StepResult(ok=False, error=f"post-invariant violated: {failed}")
        return StepResult(ok=True, state=new_state, effects=effects)
    else:
        return StepResult(ok=False, error=f"unknown action: {cmd.tag}")


# === Hypothesis test scaffolding ===
# Uncomment and install hypothesis to use property-based testing

# from hypothesis import given, strategies as st
# from hypothesis.stateful import RuleBasedStateMachine, rule, initialize
#
# class ModelStateMachine(RuleBasedStateMachine):
#     def __init__(self):
#         super().__init__()
#         self.state = init_state()
#
#     @initialize()
#     def init(self):
#         self.state = init_state()
#         ok, _ = check_invariants(self.state)
#         assert ok, 'init violates invariants'
#
#     # @rule(delta=st.integers())
#     # def advance_epoch(self, delta):
#     #     cmd = Command(tag='advance_epoch', args={'delta': delta})
#     #     result = step(self.state, cmd)
#     #     if result.ok:
#     #         self.state = result.state
#
#     # @rule(new_rate_bps=st.integers(), auth_ok=st.integers())
#     # def apply_funding(self, new_rate_bps, auth_ok):
#     #     cmd = Command(tag='apply_funding', args={'new_rate_bps': new_rate_bps, 'auth_ok': auth_ok})
#     #     result = step(self.state, cmd)
#     #     if result.ok:
#     #         self.state = result.state
#
#     # @rule(claim_amount=st.integers(), auth_ok=st.integers())
#     # def apply_insurance_claim(self, claim_amount, auth_ok):
#     #     cmd = Command(tag='apply_insurance_claim', args={'claim_amount': claim_amount, 'auth_ok': auth_ok})
#     #     result = step(self.state, cmd)
#     #     if result.ok:
#     #         self.state = result.state
#
#     # @rule(auth_ok=st.integers())
#     # def clear_breaker(self, auth_ok):
#     #     cmd = Command(tag='clear_breaker', args={'auth_ok': auth_ok})
#     #     result = step(self.state, cmd)
#     #     if result.ok:
#     #         self.state = result.state
#
#     # @rule(amount=st.integers(), auth_ok=st.integers())
#     # def deposit_collateral(self, amount, auth_ok):
#     #     cmd = Command(tag='deposit_collateral', args={'amount': amount, 'auth_ok': auth_ok})
#     #     result = step(self.state, cmd)
#     #     if result.ok:
#     #         self.state = result.state
#
#     # @rule(amount=st.integers())
#     # def deposit_insurance(self, amount):
#     #     cmd = Command(tag='deposit_insurance', args={'amount': amount})
#     #     result = step(self.state, cmd)
#     #     if result.ok:
#     #         self.state = result.state
#
#     # @rule(price_e8=st.integers())
#     # def publish_clearing_price(self, price_e8):
#     #     cmd = Command(tag='publish_clearing_price', args={'price_e8': price_e8})
#     #     result = step(self.state, cmd)
#     #     if result.ok:
#     #         self.state = result.state
#
#     # @rule(new_position_base=st.integers(), auth_ok=st.integers())
#     # def set_position(self, new_position_base, auth_ok):
#     #     cmd = Command(tag='set_position', args={'new_position_base': new_position_base, 'auth_ok': auth_ok})
#     #     result = step(self.state, cmd)
#     #     if result.ok:
#     #         self.state = result.state
#
#     # @rule()
#     # def settle_epoch(self, ):
#     #     cmd = Command(tag='settle_epoch', args={})
#     #     result = step(self.state, cmd)
#     #     if result.ok:
#     #         self.state = result.state
#
#     # @rule(amount=st.integers(), auth_ok=st.integers())
#     # def withdraw_collateral(self, amount, auth_ok):
#     #     cmd = Command(tag='withdraw_collateral', args={'amount': amount, 'auth_ok': auth_ok})
#     #     result = step(self.state, cmd)
#     #     if result.ok:
#     #         self.state = result.state
#
# TestModel = ModelStateMachine.TestCase


def replay_trace(commands: list[tuple[str, dict[str, Any]]]) -> list[StepResult]:
    """Replay a trace of commands and return results."""
    results: list[StepResult] = []
    s = init_state()
    for tag, args in commands:
        cmd = Command(tag=tag, args=args)
        result = step(s, cmd)
        results.append(result)
        if result.ok and result.state is not None:
            s = result.state
        else:
            break
    return results


if __name__ == "__main__":
    # Quick sanity check
    s0 = init_state()
    ok, failed = check_invariants(s0)
    print(f"Initial state: {s0}")
    print(f"Invariants OK: {ok}")
    if not ok:
        print(f"  Failed: {failed}")
