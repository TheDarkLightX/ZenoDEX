"""
Auto-generated Python reference model for: fee_calculation_v7
IR hash: sha256:f01bba96ef04844d09c2dac8d670e628fdd00a5dd1949b5c1f23a66a0104fd39

Generated by an offline verifier toolchain.

This file is standalone and has no toolchain dependencies.
"""

from __future__ import annotations

from dataclasses import dataclass
from typing import Any, Literal, Mapping


@dataclass(frozen=True)
class State:
    """Model state."""
    lp_fees_collected: int
    protocol_fees_collected: int
    total_fees_collected: int


@dataclass(frozen=True)
class Command:
    """Command to execute."""
    tag: Literal('calculate_fee',)
    args: Mapping[str, Any]


@dataclass(frozen=True)
class StepResult:
    """Result of a step execution."""
    ok: bool
    state: State | None = None
    effects: Mapping[str, Any] | None = None
    error: str | None = None


def init_state() -> State:
    """Return the initial state."""
    return State(
        lp_fees_collected=0,
        protocol_fees_collected=0,
        total_fees_collected=0,
    )


def check_invariants(s: State) -> tuple[bool, str | None]:
    """Check all invariants. Returns (ok, first_failed_id)."""
    if not (isinstance(s.lp_fees_collected, int) and not isinstance(s.lp_fees_collected, bool) and 0 <= s.lp_fees_collected <= 1000000000000):
        return False, 'domain_lp_fees_collected'
    if not (isinstance(s.protocol_fees_collected, int) and not isinstance(s.protocol_fees_collected, bool) and 0 <= s.protocol_fees_collected <= 1000000000000):
        return False, 'domain_protocol_fees_collected'
    if not (isinstance(s.total_fees_collected, int) and not isinstance(s.total_fees_collected, bool) and 0 <= s.total_fees_collected <= 2000000000000):
        return False, 'domain_total_fees_collected'
    if not (((s.lp_fees_collected <= 1000000000000) and (s.lp_fees_collected >= 0))):
        return False, 'inv_lp_fees_bounded'
    if not (((s.protocol_fees_collected <= 1000000000000) and (s.protocol_fees_collected >= 0))):
        return False, 'inv_protocol_fees_bounded'
    if not (((s.lp_fees_collected + s.protocol_fees_collected) == s.total_fees_collected)):
        return False, 'inv_total_fees_sum'
    return True, None


def step(s: State, cmd: Command) -> StepResult:
    """Execute a step. Returns StepResult."""
    # Check pre-state invariants
    ok, failed = check_invariants(s)
    if not ok:
        return StepResult(ok=False, error=f'pre-invariant violated: {failed}')

    if cmd.tag == 'calculate_fee':
        if 'gross_amount' not in cmd.args or not (isinstance(cmd.args['gross_amount'], int) and not isinstance(cmd.args['gross_amount'], bool) and 0 <= cmd.args['gross_amount'] <= 1000000000):
            return StepResult(ok=False, error='invalid param gross_amount')
        if 'fee_bps' not in cmd.args or not (isinstance(cmd.args['fee_bps'], int) and not isinstance(cmd.args['fee_bps'], bool) and 0 <= cmd.args['fee_bps'] <= 1000):
            return StepResult(ok=False, error='invalid param fee_bps')
        if 'protocol_fee_share_bps' not in cmd.args or not (isinstance(cmd.args['protocol_fee_share_bps'], int) and not isinstance(cmd.args['protocol_fee_share_bps'], bool) and 0 <= cmd.args['protocol_fee_share_bps'] <= 10000):
            return StepResult(ok=False, error='invalid param protocol_fee_share_bps')
        if not ((((((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) - (0 if 10000 == 0 else ((((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) // 10000) + (1 if (((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) % 10000) < 0 else 0)))) + s.lp_fees_collected) <= 1000000000000) and (((0 if 10000 == 0 else ((((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) // 10000) + (1 if (((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) % 10000) < 0 else 0))) + s.protocol_fees_collected) <= 1000000000000) and ((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) <= cmd.args['gross_amount']) and (cmd.args['fee_bps'] <= 1000) and (cmd.args['gross_amount'] <= 1000000000) and (cmd.args['protocol_fee_share_bps'] <= 10000) and (cmd.args['fee_bps'] >= 0) and (cmd.args['gross_amount'] >= 0) and (cmd.args['protocol_fee_share_bps'] >= 0))):
            return StepResult(ok=False, error='guard failed for calculate_fee')
        # Compute updates (simultaneous)
        new_state = State(
            lp_fees_collected=(((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) - (0 if 10000 == 0 else ((((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) // 10000) + (1 if (((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) % 10000) < 0 else 0)))) + s.lp_fees_collected),
            protocol_fees_collected=((0 if 10000 == 0 else ((((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) // 10000) + (1 if (((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) % 10000) < 0 else 0))) + s.protocol_fees_collected),
            total_fees_collected=((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) + s.total_fees_collected),
        )
        effects = {
            'fee': (0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))),
            'fee_split_ok': ((((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) - (0 if 10000 == 0 else ((((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) // 10000) + (1 if (((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) % 10000) < 0 else 0)))) + (0 if 10000 == 0 else ((((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) // 10000) + (1 if (((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) % 10000) < 0 else 0)))) == (0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0)))),
            'lp_fee': ((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) - (0 if 10000 == 0 else ((((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) // 10000) + (1 if (((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) % 10000) < 0 else 0)))),
            'net_amount': (cmd.args['gross_amount'] - (0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0)))),
            'net_ok': (((cmd.args['gross_amount'] - (0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0)))) + (0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0)))) == cmd.args['gross_amount']),
            'protocol_fee': (0 if 10000 == 0 else ((((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) // 10000) + (1 if (((0 if 10000 == 0 else (((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) // 10000) + (1 if ((9999 + (cmd.args['fee_bps'] * cmd.args['gross_amount'])) % 10000) < 0 else 0))) * cmd.args['protocol_fee_share_bps']) % 10000) < 0 else 0))),
        }
        ok, failed = check_invariants(new_state)
        if not ok:
            return StepResult(ok=False, error=f'post-invariant violated: {failed}')
        return StepResult(ok=True, state=new_state, effects=effects)
    else:
        return StepResult(ok=False, error=f'unknown action: {cmd.tag}')


# === Hypothesis test scaffolding ===
# Uncomment and install hypothesis to use property-based testing

# from hypothesis import given, strategies as st
# from hypothesis.stateful import RuleBasedStateMachine, rule, initialize
#
# class ModelStateMachine(RuleBasedStateMachine):
#     def __init__(self):
#         super().__init__()
#         self.state = init_state()
#
#     @initialize()
#     def init(self):
#         self.state = init_state()
#         ok, _ = check_invariants(self.state)
#         assert ok, 'init violates invariants'
#
#     # @rule(gross_amount=st.integers(), fee_bps=st.integers(), protocol_fee_share_bps=st.integers())
#     # def calculate_fee(self, gross_amount, fee_bps, protocol_fee_share_bps):
#     #     cmd = Command(tag='calculate_fee', args={'gross_amount': gross_amount, 'fee_bps': fee_bps, 'protocol_fee_share_bps': protocol_fee_share_bps})
#     #     result = step(self.state, cmd)
#     #     if result.ok:
#     #         self.state = result.state
#
# TestModel = ModelStateMachine.TestCase


def replay_trace(commands: list[tuple[str, dict[str, Any]]]) -> list[StepResult]:
    """Replay a trace of commands and return results."""
    results: list[StepResult] = []
    s = init_state()
    for tag, args in commands:
        cmd = Command(tag=tag, args=args)
        result = step(s, cmd)
        results.append(result)
        if result.ok and result.state is not None:
            s = result.state
        else:
            break
    return results


if __name__ == '__main__':
    # Quick sanity check
    s0 = init_state()
    ok, failed = check_invariants(s0)
    print(f'Initial state: {s0}')
    print(f'Invariants OK: {ok}')
    if not ok:
        print(f'  Failed: {failed}')
