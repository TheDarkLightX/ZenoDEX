# REPL IO 44: TWAP guard (2-step) using addition-only bounds
# Checks if curr is within delta of avg(prev1, prev2) without division.

p1 : bv[16] = in file("experiments/io/inputs/twap_prev1.in")
p2 : bv[16] = in file("experiments/io/inputs/twap_prev2.in")
curr : bv[16] = in file("experiments/io/inputs/twap_curr.in")
delta : bv[16] = in file("experiments/io/inputs/twap_delta.in")

low_ok : sbf = out file("experiments/io/outputs/twap_low_ok.out")
high_ok : sbf = out file("experiments/io/outputs/twap_high_ok.out")
twap_ok : sbf = out file("experiments/io/outputs/twap_ok.out")

twap_low(c : bv[16], a : bv[16], b : bv[16], d : bv[16]) := ((c + c) + (d + d)) >= (a + b)
twap_high(c : bv[16], a : bv[16], b : bv[16], d : bv[16]) := (c + c) <= ((a + b) + (d + d))

r (low_ok[t] = 1:sbf <-> twap_low(curr[t], p1[t], p2[t], delta[t])) && (high_ok[t] = 1:sbf <-> twap_high(curr[t], p1[t], p2[t], delta[t])) && (twap_ok[t] = 1:sbf <-> ((low_ok[t] = 1:sbf) && (high_ok[t] = 1:sbf)))
q
