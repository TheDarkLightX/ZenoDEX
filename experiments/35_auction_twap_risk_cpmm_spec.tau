# Spec 35: Auction clearing + TWAP guard + risk budget + CPMM gate

canonical(a : bv[16], b : bv[16], c : bv[16], d : bv[16]) := (a < b) && (b < c) && (c < d).
auction_ok(b1 : bv[16], b2 : bv[16], a1 : bv[16], a2 : bv[16], clear : bv[16]) := ((b1 >= a1) && (clear >= a1) && (clear <= b1)) || ((b1 >= a2) && (clear >= a2) && (clear <= b1)) || ((b2 >= a1) && (clear >= a1) && (clear <= b2)) || ((b2 >= a2) && (clear >= a2) && (clear <= b2)).
twap_ok(curr : bv[16], p1 : bv[16], p2 : bv[16], delta : bv[16]) := ((curr + curr) + (delta + delta) >= (p1 + p2)) && ((curr + curr) <= (p1 + p2) + (delta + delta)).
cpmm_ok(rx : bv[16], ry : bv[16], net : bv[16], out : bv[16]) := (out * (rx + net) <= net * ry).
cantrade(req : sbf, risk : sbf, cd : sbf, bal : bv[16], debit : bv[16]) := (req = 1:sbf) && (risk = 1:sbf) && (cd = 0:sbf) && (bal >= debit).

always (o1[t]:sbf = 1:sbf <-> canonical(i1[t]:bv[16], i2[t]:bv[16], i3[t]:bv[16], i4[t]:bv[16])) && (o2[t]:sbf = 1:sbf <-> auction_ok(i5[t]:bv[16], i6[t]:bv[16], i7[t]:bv[16], i8[t]:bv[16], i9[t]:bv[16])) && (o3[t]:sbf = 1:sbf <-> twap_ok(i10[t]:bv[16], i11[t]:bv[16], i12[t]:bv[16], i13[t]:bv[16])) && (o4[t]:sbf = 1:sbf <-> cpmm_ok(i18[t]:bv[16], i19[t]:bv[16], i20[t]:bv[16], i21[t]:bv[16])) && (o6[0]:bv[16] = { #x0064 }:bv[16]) && (o7[0]:sbf = 0:sbf) && (o8[0]:sbf = 0:sbf) && (o9[0]:sbf = 0:sbf) && (o5[t]:sbf = 1:sbf <-> cantrade(i14[t]:sbf, i15[t]:sbf, o9[t-1]:sbf, o6[t-1]:bv[16], i17[t]:bv[16])) && (o10[t]:sbf = i14[t]:sbf & o5[t]:sbf) && (((i16[t]:sbf = 1:sbf) && (o6[t]:bv[16] = { #x0064 }:bv[16])) || ((i16[t]:sbf = 0:sbf) && (o10[t]:sbf = 1:sbf) && (o6[t]:bv[16] = o6[t-1]:bv[16] - i17[t]:bv[16])) || ((i16[t]:sbf = 0:sbf) && (o10[t]:sbf = 0:sbf) && (o6[t]:bv[16] = o6[t-1]:bv[16]))) && (((i16[t]:sbf = 1:sbf) && (o7[t]:sbf = 0:sbf)) || ((i16[t]:sbf = 0:sbf) && (o7[t]:sbf = o10[t]:sbf))) && (((i16[t]:sbf = 1:sbf) && (o8[t]:sbf = 0:sbf)) || ((i16[t]:sbf = 0:sbf) && (o8[t]:sbf = o7[t-1]:sbf))) && (((i16[t]:sbf = 1:sbf) && (o9[t]:sbf = 0:sbf)) || ((i16[t]:sbf = 0:sbf) && (o9[t]:sbf = o7[t-1]:sbf | o8[t-1]:sbf))) && (o11[t]:sbf = o1[t] & o2[t] & o3[t] & o4[t] & o10[t]).
